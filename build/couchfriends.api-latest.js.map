{"version":3,"sources":["../src/couchfriends.api.js","../src/Emitter.js","../src/peer.js"],"names":["Emitter","obj","mixin","key","prototype","module","exports","on","addEventListener","event","fn","this","_callbacks","push","once","off","apply","arguments","removeListener","removeAllListeners","removeEventListener","length","callbacks","cb","i","splice","emit","args","slice","call","len","listeners","hasListeners","r","e","n","t","o","f","c","require","u","a","Error","code","p","1","Object","defineProperty","value","RTCSessionDescription","window","mozRTCSessionDescription","RTCPeerConnection","mozRTCPeerConnection","webkitRTCPeerConnection","RTCIceCandidate","mozRTCIceCandidate","2","DataConnection","peer","provider","options","eventemitter3_1","EventEmitter","util_1","util","extend","serialization","reliable","open","type","id","connectionId","_idPrefix","randomToken","label","metadata","_buffer","_buffering","bufferSize","_chunkedData","_payload","_peerBrowser","browser","negotiator_1","Negotiator","startConnection","originator","reliable_1","inherits","initialize","dc","_dc","dataChannel","_configureDataChannel","self","supports","sctp","binaryType","onopen","log","_reliable","Reliable","debug","onmessage","msg","_handleDataMessage","onclose","close","data","datatype","constructor","Blob","blobToArrayBuffer","ab","unpack","ArrayBuffer","String","binaryStringToArrayBuffer","JSON","parse","__peerData","chunkInfo","count","total","cleanup","send","chunked","_bufferedSend","stringify","blob","pack","needsChunking","chunkedBrowsers","size","chunkedMTU","_sendChunks","binaryBlob","blobToBinaryString","str","_trySend","setTimeout","_tryBuffer","shift","blobs","chunk","ii","handleMessage","message","payload","handleSDP","sdp","handleCandidate","candidate","warn","./negotiator","./util","eventemitter3","3","__importDefault","mod","__esModule","default","adapter_1","socket_1","mediaconnection_1","dataconnection_1","peer_1","js_binarypack_1","Socket","MediaConnection","Peer","BinaryPack","./adapter","./dataconnection","./mediaconnection","./peer","./socket","js-binarypack","4","localStream","_stream","addStream","remoteStream","answer","stream","messages","_getMessages","5","pcs","media","queue","connection","pc","_getPeerConnection","peerConnection","config","createDataChannel","_makeOffer","error","signalingState","_startPeerConnection","optional","DtlsSrtpKeyAgreement","RtpDataChannels","_setupListeners","pc_id","peerId","onicecandidate","evt","socket","dst","oniceconnectionstatechange","iceConnectionState","noop","onicechange","ondatachannel","channel","getConnection","ontrack","streams","readyState","createOffer","offer","higherBandwidthSDP","setLocalDescription","err","emitError","constraints","_makeAnswer","createAnswer","setRemoteDescription","ice","sdpMLineIndex","addIceCandidate","6","undefined","toString","host","CLOUD_HOST","port","CLOUD_PORT","path","token","defaultConfig","location","hostname","secure","isSecure","logFunction","setLogFunction","setLogLevel","audioVideo","validateId","destroyed","disconnected","connections","_lostMessages","_initializeServerConnection","_initialize","_retrieveId","_delayedAbort","wsport","_handleMessage","_abort","disconnect","http","XMLHttpRequest","protocol","url","Date","getTime","Math","random","onerror","pathError","onreadystatechange","status","responseText","start","src","_cleanupPeer","_addConnection","_storeMessage","connect","setZeroTimeout","_lastServerId","destroy","_cleanup","peers","keys","j","jj","reconnect","listAllPeers","helpfulError","7","_queue","httpProtocol","wsProtocol","_httpUrl","_wsUrl","_startXhrStream","_startWebSocket","_socket","WebSocket","_timeout","clearTimeout","_http","abort","_sendQueuedMessages","_index","_streamIndex","old","_handleStream","_setHTTPTimeout","split","index","bufferedMessage","_wsOpen","toLowerCase","setRequestHeader","8","iceServers","urls","dataCount","Chrome","logLevel","level","debugLevel","parseInt","isNaN","_printWith","_print","Function","prefix","copy","Array","unshift","l","name","console","onnegotiationneeded","reliablePC","binary","exec","validateKey","ctor","superCtor","super_","create","enumerable","writable","configurable","dest","source","hasOwnProperty","global","setZeroTimeoutPostMessage","timeouts","postMessage","messageName","stopPropagation","attachEvent","bl","chunks","ceil","end","min","b","fr","FileReader","onload","target","result","readAsArrayBuffer","readAsBinaryString","byteArray","Uint8Array","charCodeAt","buffer","substr","9","EE","context","_events","ee","a1","a2","a3","a4","a5","listener","events","addListener","setMaxListeners","EventEmitter2","EventEmitter3","10","Unpacker","dataBuffer","dataView","byteLength","Packer","bufferBuilder","BufferBuilder","_utf8Replace","m","utf8Length","replace","binaryFeatures","packer","getBuffer","unpack_uint8","unpack_raw","unpack_string","unpack_array","unpack_map","unpack_float","unpack_double","unpack_uint16","unpack_uint32","unpack_uint64","unpack_int8","unpack_int16","unpack_int32","unpack_int64","byte","bytes","read","uint16","uint32","uint64","uint8","pow","buf","fromCharCode","objects","map","sign","exp","fraction","h32","l32","hfrac","frac","subarray","pack_string","floor","pack_integer","pack_double","append","pack_array","File","pack_bin","useArrayBufferView","pack_object","toBinaryPack","flush","pack_uint8","pack_uint16","pack_uint32","ary","num","pack_int8","pack_int16","pack_int32","pack_int64","pack_uint64","LN2","frac0","frac1","b32","prop","high","low","./bufferbuilder","11","_pieces","_parts","useBlobBuilder","BlobBuilder","WebKitBlobBuilder","MozBlobBuilder","MSBlobBuilder","builder","getBlob","12","_outgoing","_incoming","_received","_window","_mtu","_interval","_count","_setupDC","_handleSend","ack","_chunk","timer","_sendWindowedChunks","_setupInterval","setInterval","_multiple","_intervalSend","_processAcks","item","indexOf","idata","odata","_ack","max","_calculateNextAck","_complete","ch","limit","sent","version","navigator","appVersion","match","parts","13","COUCHFRIENDS","REVISION","_sounds","achievement","play","file","notification","_baseUrl","playerIndex","players","_code","connected","settings","colorIndex","colors","ui","displayCode","showNotifications","sound","init","head","document","getElementsByTagName","link","createElement","rel","href","appendChild","containerDiv","innerHTML","body","_loadAudio","AudioContext","request","responseType","decodeAudioData","response","createBufferSource","destination","noteOn","showNotification","duration","defaultOptions","assign","now","notificationEl","className","getElementById","node","parentNode","removeChild","showHideHowToPopup","style","display","offsetParent","_generateColor","color","_generateCode","text","possible","charAt","conn","playerId","player","action","topic","params","html","image"],"mappings":"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","file":"couchfriends.api-latest.js","sourcesContent":["\"use strict\";\r\n/**\r\n * Couchfriends controller api. With the Couchfriends Controller API you can connect your phone or tablet to your HTML5\r\n * game and use it as a controller. The Controller API uses WebRTC (peer2peer) to send and receive input.\r\n *\r\n * @copyright (c) 2015 Mathieu de Ruiter, Couchfriends, Fellicht & Editors\r\n * @author Mathieu de Ruiter / http://www.fellicht.nl/\r\n *\r\n * For detailed information about the development with the Couchfriends API please visit https://couchfriends.com.\r\n * Please do not remove the header of this file.\r\n */\r\n\r\nvar COUCHFRIENDS = {\r\n    REVISION: '4',\r\n    /**\r\n     * Array with sounds\r\n     * @author http://opengameart.org/users/draconx\r\n     */\r\n    _sounds: {\r\n        achievement: {\r\n            play: function () {\r\n                return false;\r\n            }, // In case the file can't be loaded\r\n            file: 'achievement.wav'\r\n        },\r\n        notification: {\r\n            play: function () {\r\n                return false;\r\n            }, // In case the file can't be loaded\r\n            file: 'notification.wav'\r\n        }\r\n    },\r\n    /**\r\n     * Url/path to assets\r\n     */\r\n    _baseUrl: 'https://couchfriends.com/cdn/api/assets/',\r\n    /**\r\n     * All connected players with their id, connection object, name\r\n     */\r\n    playerIndex: 1,\r\n    players: [],\r\n    socket: {}, // The Websocket object\r\n    _code: '',\r\n    // Object with current information and state over the game\r\n    status: {\r\n        connected: false\r\n    },\r\n    /**\r\n     * Global settings for COUCHFRIENDS api\r\n     * @type {object} settings list of settings\r\n     */\r\n    settings: {\r\n        /**\r\n         * The current color index.\r\n         */\r\n        colorIndex: 0,\r\n        /**\r\n         * Available player colors.\r\n         */\r\n        colors: [\r\n            '#ff0000',\r\n            '#00ff00',\r\n            '#0000ff',\r\n            '#ffff00',\r\n            '#ff00ff',\r\n            '#00ffff',\r\n            '#ff9900',\r\n            '#6d00ff',\r\n            '#810000',\r\n            '#008100',\r\n            '#000081',\r\n            '#818100',\r\n            '#810081',\r\n            '#008181',\r\n            '#814c00',\r\n            '#370081',\r\n            '#ff7d7d',\r\n            '#7dff7d',\r\n            '#7d7dff',\r\n            '#ffff7d',\r\n            '#ff7dff',\r\n            '#7dffff',\r\n            '#ffcf8b',\r\n            '#a983ff'\r\n        ],\r\n        /**\r\n         * UI Settings\r\n         */\r\n        ui: {\r\n            displayCode: true, // Show the code to join\r\n            showNotifications: true,\r\n            sound: true\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Init some javascript and styles to the game for dynamic overviews\r\n */\r\nCOUCHFRIENDS.init = function () {\r\n    var head = document.getElementsByTagName('head')[0];\r\n    var link = document.createElement('link');\r\n    link.rel = 'stylesheet';\r\n    link.type = 'text/css';\r\n    link.href = COUCHFRIENDS._baseUrl + 'couchfriends.ui.css';\r\n    link.media = 'all';\r\n    head.appendChild(link);\r\n    var containerDiv = document.createElement(\"div\");\r\n    containerDiv.id = 'COUCHFRIENDS-overlay';\r\n    containerDiv.innerHTML = '<div id=\"COUCHFRIENDS-popup\"></div><div id=\"COUCHFRIENDS-notifications\"></div>';\r\n    document.body.appendChild(containerDiv);\r\n    COUCHFRIENDS._loadAudio();\r\n    COUCHFRIENDS.connect();\r\n};\r\n\r\ndocument.addEventListener('DOMContentLoaded', COUCHFRIENDS.init, false);\r\n\r\n/**\r\n * Load all audio files\r\n * @private\r\n */\r\nCOUCHFRIENDS._loadAudio = function () {\r\n\r\n    if (COUCHFRIENDS.settings.ui.sound == false) {\r\n        return false;\r\n    }\r\n    if (typeof AudioContext != 'function') {\r\n        return false;\r\n    }\r\n\r\n    for (var key in COUCHFRIENDS._sounds) {\r\n        if (!COUCHFRIENDS._sounds.hasOwnProperty(key)) {\r\n            continue;\r\n        }\r\n        var sound = COUCHFRIENDS._sounds[key];\r\n        var request = new XMLHttpRequest();\r\n        request.open('GET', COUCHFRIENDS._baseUrl + sound.file, true);\r\n        request.responseType = 'arraybuffer';\r\n        request.key = key;\r\n        request.onload = function () {\r\n            var context = new AudioContext();\r\n            context.key = this.key;\r\n            context.decodeAudioData(this.response, function (buffer) {\r\n                COUCHFRIENDS._sounds[context.key].play = function () {\r\n                    var source = context.createBufferSource();\r\n                    source.buffer = buffer;\r\n                    source.connect(context.destination);\r\n                    if (!source.start)\r\n                        source.start = source.noteOn;\r\n                    source.start(0);\r\n                }\r\n            });\r\n        };\r\n        request.send();\r\n    }\r\n};\r\n\r\n/**\r\n * Show notification and remove it after a short delay\r\n * @param message\r\n * @param duration the duration in ms\r\n * @param options object List with options\r\n * @param options.type string Type of the notification. Options: 'default', 'error', 'achievement'\r\n * @param options.sound boolean Play the default notification sound.\r\n */\r\nCOUCHFRIENDS.showNotification = function (message, duration, options) {\r\n    options = options || {};\r\n    if (COUCHFRIENDS.settings.ui.showNotifications == false) {\r\n        return;\r\n    }\r\n    var defaultOptions = {\r\n        type: 'default',\r\n        sound: true\r\n    };\r\n    options = Object.assign(defaultOptions, options);\r\n    duration = duration || 3500;\r\n    if (COUCHFRIENDS.settings.ui.sound && options.sound) {\r\n        COUCHFRIENDS._sounds.notification.play();\r\n    }\r\n    var id = Date.now();\r\n    var notificationEl = document.createElement(\"div\");\r\n    notificationEl.className = 'COUCHFRIENDS-notification COUCHFRIENDS-notification-' + options.type;\r\n    notificationEl.id = 'COUCHFRIENDS-' + id;\r\n    notificationEl.innerHTML = '<p>' + message + '</p>';\r\n    document.getElementById('COUCHFRIENDS-notifications').appendChild(notificationEl);\r\n    setTimeout(function () {\r\n        document.getElementById('COUCHFRIENDS-' + id).className = 'COUCHFRIENDS-notification COUCHFRIENDS-notification-' + options.type + ' COUCHFRIENDS-notification-close';\r\n        setTimeout(function () {\r\n            var node = document.getElementById('COUCHFRIENDS-' + id);\r\n            if (node.parentNode) {\r\n                node.parentNode.removeChild(node);\r\n            }\r\n        }, 1000);\r\n    }, duration);\r\n};\r\n\r\nCOUCHFRIENDS.showHideHowToPopup = function () {\r\n    if (COUCHFRIENDS.settings.displayCode == false) {\r\n        document.getElementById('COUCHFRIENDS-popup').style.display = 'none';\r\n        return;\r\n    }\r\n    if (COUCHFRIENDS.players.length > 0 || COUCHFRIENDS._code == '') {\r\n        if (document.getElementById('COUCHFRIENDS-popup').offsetParent === null) {\r\n            return;\r\n        }\r\n        document.getElementById('COUCHFRIENDS-popup').className = 'COUCHFRIENDS-moveBottomLeft';\r\n        return;\r\n    }\r\n    var message = '<img style=\"position:relative;top:4px;margin-right:5px;\" src=\"' + COUCHFRIENDS._baseUrl + 'controller-mode.png\" /> Go to <strong class=\"COUCHFRIENDS-underline\">couchfriends.com</strong> with your <strong>phone</strong> or <strong>tablet</strong> and enter the code <strong id=\"COUCHFRIENDS-code\">' + COUCHFRIENDS._code + '</strong>';\r\n    document.getElementById('COUCHFRIENDS-popup').innerHTML = message;\r\n    if (document.getElementById('COUCHFRIENDS-popup').offsetParent !== null) {\r\n        document.getElementById('COUCHFRIENDS-popup').className = 'COUCHFRIENDS-moveCenter';\r\n    }\r\n};\r\n\r\n/**\r\n * Generate a \"random\" color for the player. This is handy for creating\r\n * unique player indications. The color is sent back to the controller.\r\n * @returns {string}\r\n * @private\r\n */\r\nCOUCHFRIENDS._generateColor = function () {\r\n    var color = \"#\" + ((1 << 24) * Math.random() | 0).toString(16);\r\n    var colorIndex = COUCHFRIENDS.settings.colorIndex;\r\n    if (COUCHFRIENDS.settings.colors[colorIndex] != null) {\r\n        color = COUCHFRIENDS.settings.colors[colorIndex];\r\n        colorIndex++;\r\n    }\r\n    else {\r\n        colorIndex = 0;\r\n        color = COUCHFRIENDS.settings.colors[colorIndex];\r\n        colorIndex++;\r\n    }\r\n    COUCHFRIENDS.settings.colorIndex = colorIndex;\r\n    return color;\r\n};\r\n\r\n/**\r\n * Generate a code. Code should always be in capitals. Controller will uppercase all chars.\r\n * @param len\r\n * @returns {string}\r\n * @private\r\n */\r\nCOUCHFRIENDS._generateCode = function (len) {\r\n    len = len || 3;\r\n    var text = \"\";\r\n    var possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\"; // Caps only\r\n    for (var i = 0; i < len; i++)\r\n        text += possible.charAt(Math.floor(Math.random() * possible.length));\r\n\r\n    return text;\r\n};\r\n\r\n/**\r\n * Connect function. This will connect the game to the websocket server.\r\n *\r\n * @returns {void|boolean} false on error or return void. See the .on('connect', function() { }) callback for more info.\r\n */\r\nCOUCHFRIENDS.connect = function () {\r\n\r\n    var id = 'lwjd5qra8257b9';\r\n    var code = COUCHFRIENDS._generateCode(3);\r\n    var peer = new Peer(code, {\r\n        key: id\r\n    });\r\n    peer.on('open', function (code) {\r\n        COUCHFRIENDS.emit('connect', code);\r\n    });\r\n    peer.on('close', function () {\r\n        COUCHFRIENDS.emit('disconnect');\r\n    });\r\n    peer.on('error', function (error) {\r\n        console.log(error);\r\n    });\r\n    peer.on('connection', function (conn) {\r\n        console.log('connection');\r\n        COUCHFRIENDS.emit('player.connected', conn);\r\n    });\r\n    COUCHFRIENDS._socket = peer;\r\n};\r\n\r\n/**\r\n * Send data to the server/controller\r\n *\r\n * @param data Object object with data to send. See Api references for all available options.\r\n */\r\nCOUCHFRIENDS.send = function (data) {\r\n    if (data.id == null) {\r\n        console.warn(data);\r\n    }\r\n    for (var i = 0; i < this.players.length; i++) {\r\n        if (data.id == this.players[i].id) {\r\n            this.players[i].conn.send(data);\r\n            break;\r\n        }\r\n    }\r\n};\r\n\r\nEmitter(COUCHFRIENDS);\r\n\r\n/**\r\n * Callback when an error has occurred.\r\n *\r\n * @param {object} data list with error details.\r\n * @param {string} data.message the error\r\n */\r\nCOUCHFRIENDS.on('error', function (data) {\r\n    COUCHFRIENDS.showNotification(data, null, {\r\n        type: 'error'\r\n    })\r\n});\r\n\r\n/**\r\n * Callback after connection to the WebSocket server is successful. Best practise will be hosting a new game after\r\n * a successful connection.\r\n * @param string code. The code players can use to join.\r\n */\r\nCOUCHFRIENDS.on('connect', function (key) {\r\n    COUCHFRIENDS._code = key;\r\n    COUCHFRIENDS.showHideHowToPopup();\r\n});\r\n\r\n/**\r\n * Callback after the connection is lost from the WebSocket server.\r\n */\r\nCOUCHFRIENDS.on('disconnect', function () {\r\n    COUCHFRIENDS.showNotification('Disconnected from server...', null, {\r\n        type: 'error'\r\n    });\r\n});\r\n\r\n/**\r\n * Callback when a player connected to the game.\r\n *\r\n * @param conn the peer connection to the player.\r\n */\r\nCOUCHFRIENDS.on('player.connected', function (conn) {\r\n    COUCHFRIENDS.playerIndex++;\r\n    var playerId = COUCHFRIENDS.playerIndex;\r\n    var player = {\r\n        id: playerId,\r\n        peer: playerId, // fallback\r\n        conn: conn,\r\n        color: COUCHFRIENDS._generateColor()\r\n    };\r\n    conn.player = player;\r\n    conn.on('open', function () {\r\n\r\n        /**\r\n         * Receiving data from one of the players.\r\n         * @param data object from the controller\r\n         * @param data.topic string The action of the player\r\n         * player.orientation\r\n         * player.click\r\n         * player.clickDown\r\n         * player.clickUp\r\n         * player.buttonClick\r\n         * player.buttonDown\r\n         * player.buttonUp\r\n         * player.identify\r\n         *\r\n         * @return void\r\n         */\r\n        conn.on('data', function (data) {\r\n            data = JSON.parse(data);\r\n            var action = '';\r\n            if (data.topic === null) {\r\n                return;\r\n            }\r\n            action = data.topic;\r\n            if (data.action !== \"\") {\r\n                action += '.' + data.action;\r\n            }\r\n            var params = {};\r\n            if (data.data != null) {\r\n                params = data.data;\r\n            }\r\n            params.player = this.player;\r\n            COUCHFRIENDS.emit(action, params);\r\n        });\r\n\r\n        COUCHFRIENDS.emit('player.join', this.player);\r\n        conn.send({\r\n            type: 'player.identify',\r\n            data: {\r\n                color: this.player.color\r\n            }\r\n        });\r\n        conn.send({\r\n            type: 'game.start'\r\n        });\r\n        COUCHFRIENDS.emit('player.identify', {\r\n            color: this.player.color,\r\n            player: {\r\n                id: this.player.id\r\n            }});\r\n\r\n    });\r\n    conn.on('close', function () {\r\n        COUCHFRIENDS.emit('player.left', {\r\n            player: this.player\r\n        });\r\n    });\r\n    COUCHFRIENDS.players.push(player);\r\n    COUCHFRIENDS.showNotification('New player joined.');\r\n    COUCHFRIENDS.showHideHowToPopup();\r\n});\r\n\r\n/**\r\n * Callback when a player disconnect from the game.\r\n *\r\n * @param {object} data list with the player information\r\n * @param {int} data.player the player object\r\n */\r\nCOUCHFRIENDS.on('player.left', function (data) {\r\n    COUCHFRIENDS.players.splice(COUCHFRIENDS.players.indexOf(data.player), 1);\r\n    COUCHFRIENDS.showNotification('Player left.');\r\n    COUCHFRIENDS.showHideHowToPopup();\r\n});\r\n\r\n/**\r\n * Callback when achievement is unlocked. Displays notification and plays\r\n * a achievement sound.\r\n * @param object data\r\n * data.name the name of the achievement\r\n * data.image the url of the icon of the achievement\r\n */\r\nCOUCHFRIENDS.on('achievementUnlock', function (data) {\r\n    COUCHFRIENDS._sounds.achievement.play();\r\n    var html = '';\r\n    if (data.image != null) {\r\n        html += '<img src=\"' + data.image + '\" /> ';\r\n    }\r\n    html += 'Achievement unlocked: <strong>' + data.name + '</strong>';\r\n    COUCHFRIENDS.showNotification(html, null, {\r\n        type: 'achievement',\r\n        sound: false\r\n    });\r\n});\r\n\r\n/**\r\n * Callback when a player chances the orientation of his device. Useful for movement tracking.\r\n *\r\n * For performance reasons this function will only be called if the orientation has changed since the previous frame.\r\n *\r\n * @param {object} data list with the player id and orientation\r\n * @param {int} data.player The player object\r\n * @param {float} [data.orientation.x] The x-as orientation (-1 to 1). E.g. -0.871\r\n * @param {float} [data.orientation.y] The y-as orientation (-1 to 1). E.g. 0.12\r\n * @param {float} [data.orientation.z] The z-as orientation (-1 to 1). E.g. -0.301\r\n */\r\n// COUCHFRIENDS.on('player.orientation', function (data) {\r\n//     console.log('Player orientation changed. Player id: ' + data.id + ' Orientation: ' + data.orientation.x + ', ' + data.orientation.y + ', ' + data.orientation.z);\r\n// });\r\n\r\n/**\r\n * Callback when a player changed its name or added additional information like selected color.\r\n *\r\n * @param {object} data list with the player information\r\n * @param {int} data.id The unique identifier of the player\r\n * @param {float} [data.name] The (new) name of the player. See http://couchfriends.com/pages/profile.html for possible\r\n * names and characters that might be included in the name.\r\n */\r\nCOUCHFRIENDS.on('player.identify', function (data) {\r\n    //console.log('Player with id: '+ data.id +' changed its name to: ' + data.name);\r\n});\r\n\r\n/**\r\n * Callback when a player tapped canvas up and down\r\n *\r\n * @param {object} data list with the player information\r\n * @param {int} data.id The unique identifier of the player\r\n * @param {float} data.x Left position clicked in percentage\r\n * @param {float} data.y Top position clicked in percentage\r\n */\r\nCOUCHFRIENDS.on('player.click', function (data) {\r\n    //console.log('Player clicked. Player id: ' + data.id + ' Click position: ' + data.x + ', ' + data.y);\r\n});\r\n\r\n/**\r\n * Callback when a player tapped canvas up and down\r\n *\r\n * @param {object} data list with the player information\r\n * @param {int} data.id The unique identifier of the player\r\n * @param {float} data.x Left position clicked in percentage\r\n * @param {float} data.y Top position clicked in percentage\r\n */\r\nCOUCHFRIENDS.on('player.clickDown', function (data) {\r\n    //console.log('Player clicked. Player id: ' + data.id + ' Click position: ' + data.x + ', ' + data.y);\r\n});\r\n\r\n/**\r\n * Callback when a player tapped canvas up and down\r\n *\r\n * @param {object} data list with the player information\r\n * @param {int} data.id The unique identifier of the player\r\n * @param {float} data.x Left position clicked in percentage\r\n * @param {float} data.y Top position clicked in percentage\r\n */\r\nCOUCHFRIENDS.on('player.clickUp', function (data) {\r\n    //console.log('Player clicked. Player id: ' + data.id + ' Click position: ' + data.x + ', ' + data.y);\r\n});\r\n\r\n/**\r\n * Callback when a player tapped a button\r\n *\r\n * @param {object} data list with the player and button information\r\n * @param {int} data.id The unique identifier of the button\r\n * @param {int} data.playerId The unique identifier of the player\r\n */\r\nCOUCHFRIENDS.on('player.buttonClick', function (data) {\r\n    //console.log('Player clicked a button. Player id: ' + data.playerId + ' Button id: ' + data.id);\r\n});\r\n\r\n/**\r\n * Callback when a player tapped a button\r\n *\r\n * @param {object} data list with the player and button information\r\n * @param {int} data.player the player object\r\n * @param {object} data.button Object of the button information\r\n * @param {string} data.button.id The Button id\r\n */\r\nCOUCHFRIENDS.on('player.buttonDown', function (data) {\r\n    //console.log('Player clicked a button. Player id: ' + data.playerId + ' Button id: ' + data.button.id);\r\n});\r\n\r\n/**\r\n * Callback when a player released a button\r\n *\r\n * @param {object} data list with the player and button information\r\n * @param {int} data.player the player object\r\n * @param {object} data.button Object of the button information\r\n * @param {string} data.button.id The Button id\r\n */\r\nCOUCHFRIENDS.on('player.buttonUp', function (data) {\r\n    //console.log('Player clicked a button. Player id: ' + data.playerId + ' Button id: ' + data.button.id);\r\n});\r\n","\r\n/**\r\n * Expose `Emitter`.\r\n */\r\n\r\nif (typeof module !== 'undefined') {\r\n    module.exports = Emitter;\r\n}\r\n\r\n/**\r\n * Initialize a new `Emitter`.\r\n *\r\n * @api public\r\n */\r\n\r\nfunction Emitter(obj) {\r\n    if (obj) return mixin(obj);\r\n};\r\n\r\n/**\r\n * Mixin the emitter properties.\r\n *\r\n * @param {Object} obj\r\n * @return {Object}\r\n * @api private\r\n */\r\n\r\nfunction mixin(obj) {\r\n    for (var key in Emitter.prototype) {\r\n        obj[key] = Emitter.prototype[key];\r\n    }\r\n    return obj;\r\n}\r\n\r\n/**\r\n * Listen on the given `event` with `fn`.\r\n *\r\n * @param {String} event\r\n * @param {Function} fn\r\n * @return {Emitter}\r\n * @api public\r\n */\r\n\r\nEmitter.prototype.on =\r\n    Emitter.prototype.addEventListener = function(event, fn){\r\n        this._callbacks = this._callbacks || {};\r\n        (this._callbacks['$' + event] = this._callbacks['$' + event] || [])\r\n            .push(fn);\r\n        return this;\r\n    };\r\n\r\n/**\r\n * Adds an `event` listener that will be invoked a single\r\n * time then automatically removed.\r\n *\r\n * @param {String} event\r\n * @param {Function} fn\r\n * @return {Emitter}\r\n * @api public\r\n */\r\n\r\nEmitter.prototype.once = function(event, fn){\r\n    function on() {\r\n        this.off(event, on);\r\n        fn.apply(this, arguments);\r\n    }\r\n\r\n    on.fn = fn;\r\n    this.on(event, on);\r\n    return this;\r\n};\r\n\r\n/**\r\n * Remove the given callback for `event` or all\r\n * registered callbacks.\r\n *\r\n * @param {String} event\r\n * @param {Function} fn\r\n * @return {Emitter}\r\n * @api public\r\n */\r\n\r\nEmitter.prototype.off =\r\n    Emitter.prototype.removeListener =\r\n        Emitter.prototype.removeAllListeners =\r\n            Emitter.prototype.removeEventListener = function(event, fn){\r\n                this._callbacks = this._callbacks || {};\r\n\r\n                // all\r\n                if (0 == arguments.length) {\r\n                    this._callbacks = {};\r\n                    return this;\r\n                }\r\n\r\n                // specific event\r\n                var callbacks = this._callbacks['$' + event];\r\n                if (!callbacks) return this;\r\n\r\n                // remove all handlers\r\n                if (1 == arguments.length) {\r\n                    delete this._callbacks['$' + event];\r\n                    return this;\r\n                }\r\n\r\n                // remove specific handler\r\n                var cb;\r\n                for (var i = 0; i < callbacks.length; i++) {\r\n                    cb = callbacks[i];\r\n                    if (cb === fn || cb.fn === fn) {\r\n                        callbacks.splice(i, 1);\r\n                        break;\r\n                    }\r\n                }\r\n                return this;\r\n            };\r\n\r\n/**\r\n * Emit `event` with the given args.\r\n *\r\n * @param {String} event\r\n * @param {Mixed} ...\r\n * @return {Emitter}\r\n */\r\n\r\nEmitter.prototype.emit = function(event){\r\n    this._callbacks = this._callbacks || {};\r\n    var args = [].slice.call(arguments, 1)\r\n        , callbacks = this._callbacks['$' + event];\r\n\r\n    if (callbacks) {\r\n        callbacks = callbacks.slice(0);\r\n        for (var i = 0, len = callbacks.length; i < len; ++i) {\r\n            callbacks[i].apply(this, args);\r\n        }\r\n    }\r\n\r\n    return this;\r\n};\r\n\r\n/**\r\n * Return array of callbacks for `event`.\r\n *\r\n * @param {String} event\r\n * @return {Array}\r\n * @api public\r\n */\r\n\r\nEmitter.prototype.listeners = function(event){\r\n    this._callbacks = this._callbacks || {};\r\n    return this._callbacks['$' + event] || [];\r\n};\r\n\r\n/**\r\n * Check if this emitter has `event` handlers.\r\n *\r\n * @param {String} event\r\n * @return {Boolean}\r\n * @api public\r\n */\r\n\r\nEmitter.prototype.hasListeners = function(event){\r\n    return !! this.listeners(event).length;\r\n};\r\n","(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    exports.RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription;\r\n    exports.RTCPeerConnection = window.RTCPeerConnection ||\r\n        window.mozRTCPeerConnection ||\r\n        window.webkitRTCPeerConnection;\r\n    exports.RTCIceCandidate = window.RTCIceCandidate || window.mozRTCIceCandidate;\r\n\r\n},{}],2:[function(require,module,exports){\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    var util_1 = require(\"./util\");\r\n    var eventemitter3_1 = require(\"eventemitter3\");\r\n    var negotiator_1 = require(\"./negotiator\");\r\n    var reliable_1 = require(\"reliable\");\r\n    function DataConnection(peer, provider, options) {\r\n        if (!(this instanceof DataConnection))\r\n            return new DataConnection(peer, provider, options);\r\n        eventemitter3_1.EventEmitter.call(this);\r\n        this.options = util_1.util.extend({\r\n            serialization: \"binary\",\r\n            reliable: false\r\n        }, options);\r\n        this.open = false;\r\n        this.type = \"data\";\r\n        this.peer = peer;\r\n        this.provider = provider;\r\n        this.id =\r\n            this.options.connectionId || DataConnection._idPrefix + util_1.util.randomToken();\r\n        this.label = this.options.label || this.id;\r\n        this.metadata = this.options.metadata;\r\n        this.serialization = this.options.serialization;\r\n        this.reliable = this.options.reliable;\r\n        this._buffer = [];\r\n        this._buffering = false;\r\n        this.bufferSize = 0;\r\n        this._chunkedData = {};\r\n        if (this.options._payload) {\r\n            this._peerBrowser = this.options._payload.browser;\r\n        }\r\n        negotiator_1.Negotiator.startConnection(this, this.options._payload || {\r\n            originator: true\r\n        });\r\n    }\r\n    exports.DataConnection = DataConnection;\r\n    util_1.util.inherits(DataConnection, eventemitter3_1.EventEmitter);\r\n    DataConnection._idPrefix = \"dc_\";\r\n    DataConnection.prototype.initialize = function (dc) {\r\n        this._dc = this.dataChannel = dc;\r\n        this._configureDataChannel();\r\n    };\r\n    DataConnection.prototype._configureDataChannel = function () {\r\n        var self = this;\r\n        if (util_1.util.supports.sctp) {\r\n            this._dc.binaryType = \"arraybuffer\";\r\n        }\r\n        this._dc.onopen = function () {\r\n            util_1.util.log(\"Data channel connection success\");\r\n            self.open = true;\r\n            self.emit(\"open\");\r\n        };\r\n        if (!util_1.util.supports.sctp && this.reliable) {\r\n            this._reliable = new reliable_1.Reliable(this._dc, util_1.util.debug);\r\n        }\r\n        if (this._reliable) {\r\n            this._reliable.onmessage = function (msg) {\r\n                self.emit(\"data\", msg);\r\n            };\r\n        }\r\n        else {\r\n            this._dc.onmessage = function (e) {\r\n                self._handleDataMessage(e);\r\n            };\r\n        }\r\n        this._dc.onclose = function (e) {\r\n            util_1.util.log(\"DataChannel closed for:\", self.peer);\r\n            self.close();\r\n        };\r\n    };\r\n    DataConnection.prototype._handleDataMessage = function (e) {\r\n        var self = this;\r\n        var data = e.data;\r\n        var datatype = data.constructor;\r\n        if (this.serialization === \"binary\" || this.serialization === \"binary-utf8\") {\r\n            if (datatype === Blob) {\r\n                util_1.util.blobToArrayBuffer(data, function (ab) {\r\n                    data = util_1.util.unpack(ab);\r\n                    self.emit(\"data\", data);\r\n                });\r\n                return;\r\n            }\r\n            else if (datatype === ArrayBuffer) {\r\n                data = util_1.util.unpack(data);\r\n            }\r\n            else if (datatype === String) {\r\n                var ab = util_1.util.binaryStringToArrayBuffer(data);\r\n                data = util_1.util.unpack(ab);\r\n            }\r\n        }\r\n        else if (this.serialization === \"json\") {\r\n            data = JSON.parse(data);\r\n        }\r\n        if (data.__peerData) {\r\n            var id = data.__peerData;\r\n            var chunkInfo = this._chunkedData[id] || {\r\n                data: [],\r\n                count: 0,\r\n                total: data.total\r\n            };\r\n            chunkInfo.data[data.n] = data.data;\r\n            chunkInfo.count += 1;\r\n            if (chunkInfo.total === chunkInfo.count) {\r\n                delete this._chunkedData[id];\r\n                data = new Blob(chunkInfo.data);\r\n                this._handleDataMessage({ data: data });\r\n            }\r\n            this._chunkedData[id] = chunkInfo;\r\n            return;\r\n        }\r\n        this.emit(\"data\", data);\r\n    };\r\n    DataConnection.prototype.close = function () {\r\n        if (!this.open) {\r\n            return;\r\n        }\r\n        this.open = false;\r\n        negotiator_1.Negotiator.cleanup(this);\r\n        this.emit(\"close\");\r\n    };\r\n    DataConnection.prototype.send = function (data, chunked) {\r\n        if (!this.open) {\r\n            this.emit(\"error\", new Error(\"Connection is not open. You should listen for the `open` event before sending messages.\"));\r\n            return;\r\n        }\r\n        if (this._reliable) {\r\n            this._reliable.send(data);\r\n            return;\r\n        }\r\n        var self = this;\r\n        if (this.serialization === \"json\") {\r\n            this._bufferedSend(JSON.stringify(data));\r\n        }\r\n        else if (this.serialization === \"binary\" ||\r\n            this.serialization === \"binary-utf8\") {\r\n            var blob = util_1.util.pack(data);\r\n            var needsChunking = util_1.util.chunkedBrowsers[this._peerBrowser] ||\r\n                util_1.util.chunkedBrowsers[util_1.util.browser];\r\n            if (needsChunking && !chunked && blob.size > util_1.util.chunkedMTU) {\r\n                this._sendChunks(blob);\r\n                return;\r\n            }\r\n            if (!util_1.util.supports.sctp) {\r\n                util_1.util.blobToBinaryString(blob, function (str) {\r\n                    self._bufferedSend(str);\r\n                });\r\n            }\r\n            else if (!util_1.util.supports.binaryBlob) {\r\n                util_1.util.blobToArrayBuffer(blob, function (ab) {\r\n                    self._bufferedSend(ab);\r\n                });\r\n            }\r\n            else {\r\n                this._bufferedSend(blob);\r\n            }\r\n        }\r\n        else {\r\n            this._bufferedSend(data);\r\n        }\r\n    };\r\n    DataConnection.prototype._bufferedSend = function (msg) {\r\n        if (this._buffering || !this._trySend(msg)) {\r\n            this._buffer.push(msg);\r\n            this.bufferSize = this._buffer.length;\r\n        }\r\n    };\r\n    DataConnection.prototype._trySend = function (msg) {\r\n        try {\r\n            this._dc.send(msg);\r\n        }\r\n        catch (e) {\r\n            this._buffering = true;\r\n            var self = this;\r\n            setTimeout(function () {\r\n                self._buffering = false;\r\n                self._tryBuffer();\r\n            }, 100);\r\n            return false;\r\n        }\r\n        return true;\r\n    };\r\n    DataConnection.prototype._tryBuffer = function () {\r\n        if (this._buffer.length === 0) {\r\n            return;\r\n        }\r\n        var msg = this._buffer[0];\r\n        if (this._trySend(msg)) {\r\n            this._buffer.shift();\r\n            this.bufferSize = this._buffer.length;\r\n            this._tryBuffer();\r\n        }\r\n    };\r\n    DataConnection.prototype._sendChunks = function (blob) {\r\n        var blobs = util_1.util.chunk(blob);\r\n        for (var i = 0, ii = blobs.length; i < ii; i += 1) {\r\n            var blob = blobs[i];\r\n            this.send(blob, true);\r\n        }\r\n    };\r\n    DataConnection.prototype.handleMessage = function (message) {\r\n        var payload = message.payload;\r\n        switch (message.type) {\r\n            case \"ANSWER\":\r\n                this._peerBrowser = payload.browser;\r\n                negotiator_1.Negotiator.handleSDP(message.type, this, payload.sdp);\r\n                break;\r\n            case \"CANDIDATE\":\r\n                negotiator_1.Negotiator.handleCandidate(this, payload.candidate);\r\n                break;\r\n            default:\r\n                util_1.util.warn(\"Unrecognized message type:\", message.type, \"from peer:\", this.peer);\r\n                break;\r\n        }\r\n    };\r\n\r\n},{\"./negotiator\":5,\"./util\":8,\"eventemitter3\":9,\"reliable\":12}],3:[function(require,module,exports){\r\n    \"use strict\";\r\n    var __importDefault = (this && this.__importDefault) || function (mod) {\r\n        return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n    };\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    var util_1 = require(\"./util\");\r\n    var adapter_1 = require(\"./adapter\");\r\n    var socket_1 = require(\"./socket\");\r\n    var mediaconnection_1 = require(\"./mediaconnection\");\r\n    var dataconnection_1 = require(\"./dataconnection\");\r\n    var peer_1 = require(\"./peer\");\r\n    var negotiator_1 = require(\"./negotiator\");\r\n    var js_binarypack_1 = __importDefault(require(\"js-binarypack\"));\r\n    window.Socket = socket_1.Socket;\r\n    window.MediaConnection = mediaconnection_1.MediaConnection;\r\n    window.DataConnection = dataconnection_1.DataConnection;\r\n    window.Peer = peer_1.Peer;\r\n    window.RTCPeerConnection = adapter_1.RTCPeerConnection;\r\n    window.RTCSessionDescription = adapter_1.RTCSessionDescription;\r\n    window.RTCIceCandidate = adapter_1.RTCIceCandidate;\r\n    window.Negotiator = negotiator_1.Negotiator;\r\n    window.util = util_1.util;\r\n    window.BinaryPack = js_binarypack_1.default;\r\n\r\n},{\"./adapter\":1,\"./dataconnection\":2,\"./mediaconnection\":4,\"./negotiator\":5,\"./peer\":6,\"./socket\":7,\"./util\":8,\"js-binarypack\":10}],4:[function(require,module,exports){\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    var util_1 = require(\"./util\");\r\n    var eventemitter3_1 = require(\"eventemitter3\");\r\n    var negotiator_1 = require(\"./negotiator\");\r\n    function MediaConnection(peer, provider, options) {\r\n        if (!(this instanceof MediaConnection))\r\n            return new MediaConnection(peer, provider, options);\r\n        eventemitter3_1.EventEmitter.call(this);\r\n        this.options = util_1.util.extend({}, options);\r\n        this.open = false;\r\n        this.type = \"media\";\r\n        this.peer = peer;\r\n        this.provider = provider;\r\n        this.metadata = this.options.metadata;\r\n        this.localStream = this.options._stream;\r\n        this.id =\r\n            this.options.connectionId || MediaConnection._idPrefix + util_1.util.randomToken();\r\n        if (this.localStream) {\r\n            negotiator_1.Negotiator.startConnection(this, {\r\n                _stream: this.localStream,\r\n                originator: true\r\n            });\r\n        }\r\n    }\r\n    exports.MediaConnection = MediaConnection;\r\n    util_1.util.inherits(MediaConnection, eventemitter3_1.EventEmitter);\r\n    MediaConnection._idPrefix = \"mc_\";\r\n    MediaConnection.prototype.addStream = function (remoteStream) {\r\n        util_1.util.log(\"Receiving stream\", remoteStream);\r\n        this.remoteStream = remoteStream;\r\n        this.emit(\"stream\", remoteStream);\r\n    };\r\n    MediaConnection.prototype.handleMessage = function (message) {\r\n        var payload = message.payload;\r\n        switch (message.type) {\r\n            case \"ANSWER\":\r\n                negotiator_1.Negotiator.handleSDP(message.type, this, payload.sdp);\r\n                this.open = true;\r\n                break;\r\n            case \"CANDIDATE\":\r\n                negotiator_1.Negotiator.handleCandidate(this, payload.candidate);\r\n                break;\r\n            default:\r\n                util_1.util.warn(\"Unrecognized message type:\", message.type, \"from peer:\", this.peer);\r\n                break;\r\n        }\r\n    };\r\n    MediaConnection.prototype.answer = function (stream) {\r\n        if (this.localStream) {\r\n            util_1.util.warn(\"Local stream already exists on this MediaConnection. Are you answering a call twice?\");\r\n            return;\r\n        }\r\n        this.options._payload._stream = stream;\r\n        this.localStream = stream;\r\n        negotiator_1.Negotiator.startConnection(this, this.options._payload);\r\n        var messages = this.provider._getMessages(this.id);\r\n        for (var i = 0, ii = messages.length; i < ii; i += 1) {\r\n            this.handleMessage(messages[i]);\r\n        }\r\n        this.open = true;\r\n    };\r\n    MediaConnection.prototype.close = function () {\r\n        if (!this.open) {\r\n            return;\r\n        }\r\n        this.open = false;\r\n        negotiator_1.Negotiator.cleanup(this);\r\n        this.emit(\"close\");\r\n    };\r\n\r\n},{\"./negotiator\":5,\"./util\":8,\"eventemitter3\":9}],5:[function(require,module,exports){\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    var util_1 = require(\"./util\");\r\n    var adapter_1 = require(\"./adapter\");\r\n    exports.Negotiator = {\r\n        pcs: {\r\n            data: {},\r\n            media: {}\r\n        },\r\n        queue: []\r\n    };\r\n    exports.Negotiator._idPrefix = \"pc_\";\r\n    exports.Negotiator.startConnection = function (connection, options) {\r\n        var pc = exports.Negotiator._getPeerConnection(connection, options);\r\n        connection.pc = connection.peerConnection = pc;\r\n        if (connection.type === \"media\" && options._stream) {\r\n            pc.addStream(options._stream);\r\n        }\r\n        if (options.originator) {\r\n            if (connection.type === \"data\") {\r\n                var config = {};\r\n                if (!util_1.util.supports.sctp) {\r\n                    config = { reliable: options.reliable };\r\n                }\r\n                var dc = pc.createDataChannel(connection.label, config);\r\n                connection.initialize(dc);\r\n            }\r\n            exports.Negotiator._makeOffer(connection);\r\n        }\r\n        else {\r\n            exports.Negotiator.handleSDP(\"OFFER\", connection, options.sdp);\r\n        }\r\n    };\r\n    exports.Negotiator._getPeerConnection = function (connection, options) {\r\n        if (!exports.Negotiator.pcs[connection.type]) {\r\n            util_1.util.error(connection.type +\r\n                \" is not a valid connection type. Maybe you overrode the `type` property somewhere.\");\r\n        }\r\n        if (!exports.Negotiator.pcs[connection.type][connection.peer]) {\r\n            exports.Negotiator.pcs[connection.type][connection.peer] = {};\r\n        }\r\n        var peerConnections = exports.Negotiator.pcs[connection.type][connection.peer];\r\n        var pc;\r\n        if (options.pc) {\r\n            pc = exports.Negotiator.pcs[connection.type][connection.peer][options.pc];\r\n        }\r\n        if (!pc || pc.signalingState !== \"stable\") {\r\n            pc = exports.Negotiator._startPeerConnection(connection);\r\n        }\r\n        return pc;\r\n    };\r\n    exports.Negotiator._startPeerConnection = function (connection) {\r\n        util_1.util.log(\"Creating RTCPeerConnection.\");\r\n        var id = exports.Negotiator._idPrefix + util_1.util.randomToken();\r\n        var optional = {};\r\n        if (connection.type === \"data\" && !util_1.util.supports.sctp) {\r\n            optional = { optional: [{ RtpDataChannels: true }] };\r\n        }\r\n        else if (connection.type === \"media\") {\r\n            optional = { optional: [{ DtlsSrtpKeyAgreement: true }] };\r\n        }\r\n        var pc = new adapter_1.RTCPeerConnection(connection.provider.options.config, optional);\r\n        exports.Negotiator.pcs[connection.type][connection.peer][id] = pc;\r\n        exports.Negotiator._setupListeners(connection, pc, id);\r\n        return pc;\r\n    };\r\n    exports.Negotiator._setupListeners = function (connection, pc, pc_id) {\r\n        var peerId = connection.peer;\r\n        var connectionId = connection.id;\r\n        var provider = connection.provider;\r\n        util_1.util.log(\"Listening for ICE candidates.\");\r\n        pc.onicecandidate = function (evt) {\r\n            if (evt.candidate) {\r\n                util_1.util.log(\"Received ICE candidates for:\", connection.peer);\r\n                provider.socket.send({\r\n                    type: \"CANDIDATE\",\r\n                    payload: {\r\n                        candidate: evt.candidate,\r\n                        type: connection.type,\r\n                        connectionId: connection.id\r\n                    },\r\n                    dst: peerId\r\n                });\r\n            }\r\n        };\r\n        pc.oniceconnectionstatechange = function () {\r\n            switch (pc.iceConnectionState) {\r\n                case \"failed\":\r\n                    util_1.util.log(\"iceConnectionState is disconnected, closing connections to \" + peerId);\r\n                    connection.emit(\"error\", new Error(\"Negotiation of connection to \" + peerId + \" failed.\"));\r\n                    connection.close();\r\n                    break;\r\n                case \"disconnected\":\r\n                    util_1.util.log(\"iceConnectionState is disconnected, closing connections to \" + peerId);\r\n                    connection.close();\r\n                    break;\r\n                case \"completed\":\r\n                    pc.onicecandidate = util_1.util.noop;\r\n                    break;\r\n            }\r\n        };\r\n        pc.onicechange = pc.oniceconnectionstatechange;\r\n        util_1.util.log(\"Listening for data channel\");\r\n        pc.ondatachannel = function (evt) {\r\n            util_1.util.log(\"Received data channel\");\r\n            var dc = evt.channel;\r\n            var connection = provider.getConnection(peerId, connectionId);\r\n            connection.initialize(dc);\r\n        };\r\n        util_1.util.log(\"Listening for remote stream\");\r\n        pc.ontrack = function (evt) {\r\n            util_1.util.log(\"Received remote stream\");\r\n            var stream = evt.streams[0];\r\n            var connection = provider.getConnection(peerId, connectionId);\r\n            if (connection.type === \"media\") {\r\n                connection.addStream(stream);\r\n            }\r\n        };\r\n    };\r\n    exports.Negotiator.cleanup = function (connection) {\r\n        util_1.util.log(\"Cleaning up PeerConnection to \" + connection.peer);\r\n        var pc = connection.pc;\r\n        if (!!pc &&\r\n            ((pc.readyState && pc.readyState !== \"closed\") ||\r\n                pc.signalingState !== \"closed\")) {\r\n            pc.close();\r\n            connection.pc = null;\r\n        }\r\n    };\r\n    exports.Negotiator._makeOffer = function (connection) {\r\n        var pc = connection.pc;\r\n        pc.createOffer(function (offer) {\r\n            util_1.util.log(\"Created offer.\");\r\n            if (!util_1.util.supports.sctp &&\r\n                connection.type === \"data\" &&\r\n                connection.reliable) {\r\n                offer.sdp = Reliable.higherBandwidthSDP(offer.sdp);\r\n            }\r\n            pc.setLocalDescription(offer, function () {\r\n                util_1.util.log(\"Set localDescription: offer\", \"for:\", connection.peer);\r\n                connection.provider.socket.send({\r\n                    type: \"OFFER\",\r\n                    payload: {\r\n                        sdp: offer,\r\n                        type: connection.type,\r\n                        label: connection.label,\r\n                        connectionId: connection.id,\r\n                        reliable: connection.reliable,\r\n                        serialization: connection.serialization,\r\n                        metadata: connection.metadata,\r\n                        browser: util_1.util.browser\r\n                    },\r\n                    dst: connection.peer\r\n                });\r\n            }, function (err) {\r\n                if (err !=\r\n                    \"OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer\") {\r\n                    connection.provider.emitError(\"webrtc\", err);\r\n                    util_1.util.log(\"Failed to setLocalDescription, \", err);\r\n                }\r\n            });\r\n        }, function (err) {\r\n            connection.provider.emitError(\"webrtc\", err);\r\n            util_1.util.log(\"Failed to createOffer, \", err);\r\n        }, connection.options.constraints);\r\n    };\r\n    exports.Negotiator._makeAnswer = function (connection) {\r\n        var pc = connection.pc;\r\n        pc.createAnswer(function (answer) {\r\n            util_1.util.log(\"Created answer.\");\r\n            if (!util_1.util.supports.sctp &&\r\n                connection.type === \"data\" &&\r\n                connection.reliable) {\r\n                answer.sdp = Reliable.higherBandwidthSDP(answer.sdp);\r\n            }\r\n            pc.setLocalDescription(answer, function () {\r\n                util_1.util.log(\"Set localDescription: answer\", \"for:\", connection.peer);\r\n                connection.provider.socket.send({\r\n                    type: \"ANSWER\",\r\n                    payload: {\r\n                        sdp: answer,\r\n                        type: connection.type,\r\n                        connectionId: connection.id,\r\n                        browser: util_1.util.browser\r\n                    },\r\n                    dst: connection.peer\r\n                });\r\n            }, function (err) {\r\n                connection.provider.emitError(\"webrtc\", err);\r\n                util_1.util.log(\"Failed to setLocalDescription, \", err);\r\n            });\r\n        }, function (err) {\r\n            connection.provider.emitError(\"webrtc\", err);\r\n            util_1.util.log(\"Failed to create answer, \", err);\r\n        });\r\n    };\r\n    exports.Negotiator.handleSDP = function (type, connection, sdp) {\r\n        sdp = new adapter_1.RTCSessionDescription(sdp);\r\n        var pc = connection.pc;\r\n        util_1.util.log(\"Setting remote description\", sdp);\r\n        pc.setRemoteDescription(sdp, function () {\r\n            util_1.util.log(\"Set remoteDescription:\", type, \"for:\", connection.peer);\r\n            if (type === \"OFFER\") {\r\n                exports.Negotiator._makeAnswer(connection);\r\n            }\r\n        }, function (err) {\r\n            connection.provider.emitError(\"webrtc\", err);\r\n            util_1.util.log(\"Failed to setRemoteDescription, \", err);\r\n        });\r\n    };\r\n    exports.Negotiator.handleCandidate = function (connection, ice) {\r\n        var candidate = ice.candidate;\r\n        var sdpMLineIndex = ice.sdpMLineIndex;\r\n        connection.pc.addIceCandidate(new adapter_1.RTCIceCandidate({\r\n            sdpMLineIndex: sdpMLineIndex,\r\n            candidate: candidate\r\n        }));\r\n        util_1.util.log(\"Added ICE candidate for:\", connection.peer);\r\n    };\r\n\r\n},{\"./adapter\":1,\"./util\":8}],6:[function(require,module,exports){\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    var util_1 = require(\"./util\");\r\n    var eventemitter3_1 = require(\"eventemitter3\");\r\n    var socket_1 = require(\"./socket\");\r\n    var mediaconnection_1 = require(\"./mediaconnection\");\r\n    var dataconnection_1 = require(\"./dataconnection\");\r\n    function Peer(id, options) {\r\n        if (!(this instanceof Peer))\r\n            return new Peer(id, options);\r\n        eventemitter3_1.EventEmitter.call(this);\r\n        if (id && id.constructor == Object) {\r\n            options = id;\r\n            id = undefined;\r\n        }\r\n        else if (id) {\r\n            id = id.toString();\r\n        }\r\n        options = util_1.util.extend({\r\n            debug: 0,\r\n            host: util_1.util.CLOUD_HOST,\r\n            port: util_1.util.CLOUD_PORT,\r\n            path: \"/\",\r\n            token: util_1.util.randomToken(),\r\n            config: util_1.util.defaultConfig\r\n        }, options);\r\n        options.key = \"peerjs\";\r\n        this.options = options;\r\n        if (options.host === \"/\") {\r\n            options.host = window.location.hostname;\r\n        }\r\n        if (options.path[0] !== \"/\") {\r\n            options.path = \"/\" + options.path;\r\n        }\r\n        if (options.path[options.path.length - 1] !== \"/\") {\r\n            options.path += \"/\";\r\n        }\r\n        if (options.secure === undefined && options.host !== util_1.util.CLOUD_HOST) {\r\n            options.secure = util_1.util.isSecure();\r\n        }\r\n        else if (options.host == util_1.util.CLOUD_HOST) {\r\n            options.secure = true;\r\n        }\r\n        if (options.logFunction) {\r\n            util_1.util.setLogFunction(options.logFunction);\r\n        }\r\n        util_1.util.setLogLevel(options.debug);\r\n        if (!util_1.util.supports.audioVideo && !util_1.util.supports.data) {\r\n            this._delayedAbort(\"browser-incompatible\", \"The current browser does not support WebRTC\");\r\n            return;\r\n        }\r\n        if (!util_1.util.validateId(id)) {\r\n            this._delayedAbort(\"invalid-id\", 'ID \"' + id + '\" is invalid');\r\n            return;\r\n        }\r\n        this.destroyed = false;\r\n        this.disconnected = false;\r\n        this.open = false;\r\n        this.connections = {};\r\n        this._lostMessages = {};\r\n        this._initializeServerConnection();\r\n        if (id) {\r\n            this._initialize(id);\r\n        }\r\n        else {\r\n            this._retrieveId();\r\n        }\r\n    }\r\n    exports.Peer = Peer;\r\n    util_1.util.inherits(Peer, eventemitter3_1.EventEmitter);\r\n    Peer.prototype._initializeServerConnection = function () {\r\n        var self = this;\r\n        this.socket = new socket_1.Socket(this.options.secure, this.options.host, this.options.port, this.options.path, this.options.key, this.options.wsport);\r\n        this.socket.on(\"message\", function (data) {\r\n            self._handleMessage(data);\r\n        });\r\n        this.socket.on(\"error\", function (error) {\r\n            self._abort(\"socket-error\", error);\r\n        });\r\n        this.socket.on(\"disconnected\", function () {\r\n            if (!self.disconnected) {\r\n                self.emitError(\"network\", \"Lost connection to server.\");\r\n                self.disconnect();\r\n            }\r\n        });\r\n        this.socket.on(\"close\", function () {\r\n            if (!self.disconnected) {\r\n                self._abort(\"socket-closed\", \"Underlying socket is already closed.\");\r\n            }\r\n        });\r\n    };\r\n    Peer.prototype._retrieveId = function (cb) {\r\n        var self = this;\r\n        var http = new XMLHttpRequest();\r\n        var protocol = this.options.secure ? \"https://\" : \"http://\";\r\n        var url = protocol +\r\n            this.options.host +\r\n            \":\" +\r\n            this.options.port +\r\n            this.options.path +\r\n            this.options.key +\r\n            \"/id\";\r\n        var queryString = \"?ts=\" + new Date().getTime() + \"\" + Math.random();\r\n        url += queryString;\r\n        http.open(\"get\", url, true);\r\n        http.onerror = function (e) {\r\n            util_1.util.error(\"Error retrieving ID\", e);\r\n            var pathError = \"\";\r\n            if (self.options.path === \"/\" && self.options.host !== util_1.util.CLOUD_HOST) {\r\n                pathError =\r\n                    \" If you passed in a `path` to your self-hosted PeerServer, \" +\r\n                    \"you'll also need to pass in that same path when creating a new \" +\r\n                    \"Peer.\";\r\n            }\r\n            self._abort(\"server-error\", \"Could not get an ID from the server.\" + pathError);\r\n        };\r\n        http.onreadystatechange = function () {\r\n            if (http.readyState !== 4) {\r\n                return;\r\n            }\r\n            if (http.status !== 200) {\r\n                http.onerror();\r\n                return;\r\n            }\r\n            self._initialize(http.responseText);\r\n        };\r\n        http.send(null);\r\n    };\r\n    Peer.prototype._initialize = function (id) {\r\n        this.id = id;\r\n        this.socket.start(this.id, this.options.token);\r\n    };\r\n    Peer.prototype._handleMessage = function (message) {\r\n        var type = message.type;\r\n        var payload = message.payload;\r\n        var peer = message.src;\r\n        var connection;\r\n        switch (type) {\r\n            case \"OPEN\":\r\n                this.emit(\"open\", this.id);\r\n                this.open = true;\r\n                break;\r\n            case \"ERROR\":\r\n                this._abort(\"server-error\", payload.msg);\r\n                break;\r\n            case \"ID-TAKEN\":\r\n                this._abort(\"unavailable-id\", \"ID `\" + this.id + \"` is taken\");\r\n                break;\r\n            case \"INVALID-KEY\":\r\n                this._abort(\"invalid-key\", 'API KEY \"' + this.options.key + '\" is invalid');\r\n                break;\r\n            case \"LEAVE\":\r\n                util_1.util.log(\"Received leave message from\", peer);\r\n                this._cleanupPeer(peer);\r\n                break;\r\n            case \"EXPIRE\":\r\n                this.emitError(\"peer-unavailable\", \"Could not connect to peer \" + peer);\r\n                break;\r\n            case \"OFFER\":\r\n                var connectionId = payload.connectionId;\r\n                connection = this.getConnection(peer, connectionId);\r\n                if (connection) {\r\n                    connection.close();\r\n                    util_1.util.warn(\"Offer received for existing Connection ID:\", connectionId);\r\n                }\r\n                if (payload.type === \"media\") {\r\n                    connection = new mediaconnection_1.MediaConnection(peer, this, {\r\n                        connectionId: connectionId,\r\n                        _payload: payload,\r\n                        metadata: payload.metadata\r\n                    });\r\n                    this._addConnection(peer, connection);\r\n                    this.emit(\"call\", connection);\r\n                }\r\n                else if (payload.type === \"data\") {\r\n                    connection = new dataconnection_1.DataConnection(peer, this, {\r\n                        connectionId: connectionId,\r\n                        _payload: payload,\r\n                        metadata: payload.metadata,\r\n                        label: payload.label,\r\n                        serialization: payload.serialization,\r\n                        reliable: payload.reliable\r\n                    });\r\n                    this._addConnection(peer, connection);\r\n                    this.emit(\"connection\", connection);\r\n                }\r\n                else {\r\n                    util_1.util.warn(\"Received malformed connection type:\", payload.type);\r\n                    return;\r\n                }\r\n                var messages = this._getMessages(connectionId);\r\n                for (var i = 0, ii = messages.length; i < ii; i += 1) {\r\n                    connection.handleMessage(messages[i]);\r\n                }\r\n                break;\r\n            default:\r\n                if (!payload) {\r\n                    util_1.util.warn(\"You received a malformed message from \" + peer + \" of type \" + type);\r\n                    return;\r\n                }\r\n                var id = payload.connectionId;\r\n                connection = this.getConnection(peer, id);\r\n                if (connection && connection.pc) {\r\n                    connection.handleMessage(message);\r\n                }\r\n                else if (id) {\r\n                    this._storeMessage(id, message);\r\n                }\r\n                else {\r\n                    util_1.util.warn(\"You received an unrecognized message:\", message);\r\n                }\r\n                break;\r\n        }\r\n    };\r\n    Peer.prototype._storeMessage = function (connectionId, message) {\r\n        if (!this._lostMessages[connectionId]) {\r\n            this._lostMessages[connectionId] = [];\r\n        }\r\n        this._lostMessages[connectionId].push(message);\r\n    };\r\n    Peer.prototype._getMessages = function (connectionId) {\r\n        var messages = this._lostMessages[connectionId];\r\n        if (messages) {\r\n            delete this._lostMessages[connectionId];\r\n            return messages;\r\n        }\r\n        else {\r\n            return [];\r\n        }\r\n    };\r\n    Peer.prototype.connect = function (peer, options) {\r\n        if (this.disconnected) {\r\n            util_1.util.warn(\"You cannot connect to a new Peer because you called \" +\r\n                \".disconnect() on this Peer and ended your connection with the \" +\r\n                \"server. You can create a new Peer to reconnect, or call reconnect \" +\r\n                \"on this peer if you believe its ID to still be available.\");\r\n            this.emitError(\"disconnected\", \"Cannot connect to new Peer after disconnecting from server.\");\r\n            return;\r\n        }\r\n        var connection = new dataconnection_1.DataConnection(peer, this, options);\r\n        this._addConnection(peer, connection);\r\n        return connection;\r\n    };\r\n    Peer.prototype.call = function (peer, stream, options) {\r\n        if (this.disconnected) {\r\n            util_1.util.warn(\"You cannot connect to a new Peer because you called \" +\r\n                \".disconnect() on this Peer and ended your connection with the \" +\r\n                \"server. You can create a new Peer to reconnect.\");\r\n            this.emitError(\"disconnected\", \"Cannot connect to new Peer after disconnecting from server.\");\r\n            return;\r\n        }\r\n        if (!stream) {\r\n            util_1.util.error(\"To call a peer, you must provide a stream from your browser's `getUserMedia`.\");\r\n            return;\r\n        }\r\n        options = options || {};\r\n        options._stream = stream;\r\n        var call = new mediaconnection_1.MediaConnection(peer, this, options);\r\n        this._addConnection(peer, call);\r\n        return call;\r\n    };\r\n    Peer.prototype._addConnection = function (peer, connection) {\r\n        if (!this.connections[peer]) {\r\n            this.connections[peer] = [];\r\n        }\r\n        this.connections[peer].push(connection);\r\n    };\r\n    Peer.prototype.getConnection = function (peer, id) {\r\n        var connections = this.connections[peer];\r\n        if (!connections) {\r\n            return null;\r\n        }\r\n        for (var i = 0, ii = connections.length; i < ii; i++) {\r\n            if (connections[i].id === id) {\r\n                return connections[i];\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n    Peer.prototype._delayedAbort = function (type, message) {\r\n        var self = this;\r\n        util_1.util.setZeroTimeout(function () {\r\n            self._abort(type, message);\r\n        });\r\n    };\r\n    Peer.prototype._abort = function (type, message) {\r\n        util_1.util.error(\"Aborting!\");\r\n        if (!this._lastServerId) {\r\n            this.destroy();\r\n        }\r\n        else {\r\n            this.disconnect();\r\n        }\r\n        this.emitError(type, message);\r\n    };\r\n    Peer.prototype.emitError = function (type, err) {\r\n        util_1.util.error(\"Error:\", err);\r\n        if (typeof err === \"string\") {\r\n            err = new Error(err);\r\n        }\r\n        err.type = type;\r\n        this.emit(\"error\", err);\r\n    };\r\n    Peer.prototype.destroy = function () {\r\n        if (!this.destroyed) {\r\n            this._cleanup();\r\n            this.disconnect();\r\n            this.destroyed = true;\r\n        }\r\n    };\r\n    Peer.prototype._cleanup = function () {\r\n        if (this.connections) {\r\n            var peers = Object.keys(this.connections);\r\n            for (var i = 0, ii = peers.length; i < ii; i++) {\r\n                this._cleanupPeer(peers[i]);\r\n            }\r\n        }\r\n        this.emit(\"close\");\r\n    };\r\n    Peer.prototype._cleanupPeer = function (peer) {\r\n        var connections = this.connections[peer];\r\n        for (var j = 0, jj = connections.length; j < jj; j += 1) {\r\n            connections[j].close();\r\n        }\r\n    };\r\n    Peer.prototype.disconnect = function () {\r\n        var self = this;\r\n        util_1.util.setZeroTimeout(function () {\r\n            if (!self.disconnected) {\r\n                self.disconnected = true;\r\n                self.open = false;\r\n                if (self.socket) {\r\n                    self.socket.close();\r\n                }\r\n                self.emit(\"disconnected\", self.id);\r\n                self._lastServerId = self.id;\r\n                self.id = null;\r\n            }\r\n        });\r\n    };\r\n    Peer.prototype.reconnect = function () {\r\n        if (this.disconnected && !this.destroyed) {\r\n            util_1.util.log(\"Attempting reconnection to server with ID \" + this._lastServerId);\r\n            this.disconnected = false;\r\n            this._initializeServerConnection();\r\n            this._initialize(this._lastServerId);\r\n        }\r\n        else if (this.destroyed) {\r\n            throw new Error(\"This peer cannot reconnect to the server. It has already been destroyed.\");\r\n        }\r\n        else if (!this.disconnected && !this.open) {\r\n            util_1.util.error(\"In a hurry? We're still trying to make the initial connection!\");\r\n        }\r\n        else {\r\n            throw new Error(\"Peer \" +\r\n                this.id +\r\n                \" cannot reconnect because it is not disconnected from the server!\");\r\n        }\r\n    };\r\n    Peer.prototype.listAllPeers = function (cb) {\r\n        cb = cb || function () { };\r\n        var self = this;\r\n        var http = new XMLHttpRequest();\r\n        var protocol = this.options.secure ? \"https://\" : \"http://\";\r\n        var url = protocol +\r\n            this.options.host +\r\n            \":\" +\r\n            this.options.port +\r\n            this.options.path +\r\n            this.options.key +\r\n            \"/peers\";\r\n        var queryString = \"?ts=\" + new Date().getTime() + \"\" + Math.random();\r\n        url += queryString;\r\n        http.open(\"get\", url, true);\r\n        http.onerror = function (e) {\r\n            self._abort(\"server-error\", \"Could not get peers from the server.\");\r\n            cb([]);\r\n        };\r\n        http.onreadystatechange = function () {\r\n            if (http.readyState !== 4) {\r\n                return;\r\n            }\r\n            if (http.status === 401) {\r\n                var helpfulError = \"\";\r\n                if (self.options.host !== util_1.util.CLOUD_HOST) {\r\n                    helpfulError =\r\n                        \"It looks like you're using the cloud server. You can email \" +\r\n                        \"team@peerjs.com to enable peer listing for your API key.\";\r\n                }\r\n                else {\r\n                    helpfulError =\r\n                        \"You need to enable `allow_discovery` on your self-hosted \" +\r\n                        \"PeerServer to use this feature.\";\r\n                }\r\n                cb([]);\r\n                throw new Error(\"It doesn't look like you have permission to list peers IDs. \" +\r\n                    helpfulError);\r\n            }\r\n            else if (http.status !== 200) {\r\n                cb([]);\r\n            }\r\n            else {\r\n                cb(JSON.parse(http.responseText));\r\n            }\r\n        };\r\n        http.send(null);\r\n    };\r\n\r\n},{\"./dataconnection\":2,\"./mediaconnection\":4,\"./socket\":7,\"./util\":8,\"eventemitter3\":9}],7:[function(require,module,exports){\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    var util_1 = require(\"./util\");\r\n    var eventemitter3_1 = require(\"eventemitter3\");\r\n    function Socket(secure, host, port, path, key, wsport) {\r\n        if (!(this instanceof Socket))\r\n            return new Socket(secure, host, port, path, key, wsport);\r\n        wsport = wsport || port;\r\n        eventemitter3_1.EventEmitter.call(this);\r\n        this.disconnected = false;\r\n        this._queue = [];\r\n        var httpProtocol = secure ? \"https://\" : \"http://\";\r\n        var wsProtocol = secure ? \"wss://\" : \"ws://\";\r\n        this._httpUrl = httpProtocol + host + \":\" + port + path + key;\r\n        this._wsUrl = wsProtocol + host + \":\" + wsport + path + \"peerjs?key=\" + key;\r\n    }\r\n    exports.Socket = Socket;\r\n    util_1.util.inherits(Socket, eventemitter3_1.EventEmitter);\r\n    Socket.prototype.start = function (id, token) {\r\n        this.id = id;\r\n        this._httpUrl += \"/\" + id + \"/\" + token;\r\n        this._wsUrl += \"&id=\" + id + \"&token=\" + token;\r\n        this._startXhrStream();\r\n        this._startWebSocket();\r\n    };\r\n    Socket.prototype._startWebSocket = function (id) {\r\n        var self = this;\r\n        if (this._socket) {\r\n            return;\r\n        }\r\n        this._socket = new WebSocket(this._wsUrl);\r\n        this._socket.onmessage = function (event) {\r\n            try {\r\n                var data = JSON.parse(event.data);\r\n            }\r\n            catch (e) {\r\n                util_1.util.log(\"Invalid server message\", event.data);\r\n                return;\r\n            }\r\n            self.emit(\"message\", data);\r\n        };\r\n        this._socket.onclose = function (event) {\r\n            util_1.util.log(\"Socket closed.\");\r\n            self.disconnected = true;\r\n            self.emit(\"disconnected\");\r\n        };\r\n        this._socket.onopen = function () {\r\n            if (self._timeout) {\r\n                clearTimeout(self._timeout);\r\n                setTimeout(function () {\r\n                    self._http.abort();\r\n                    self._http = null;\r\n                }, 5000);\r\n            }\r\n            self._sendQueuedMessages();\r\n            util_1.util.log(\"Socket open\");\r\n        };\r\n    };\r\n    Socket.prototype._startXhrStream = function (n) {\r\n        try {\r\n            var self = this;\r\n            this._http = new XMLHttpRequest();\r\n            this._http._index = 1;\r\n            this._http._streamIndex = n || 0;\r\n            this._http.open(\"post\", this._httpUrl + \"/id?i=\" + this._http._streamIndex, true);\r\n            this._http.onerror = function () {\r\n                clearTimeout(self._timeout);\r\n                self.emit(\"disconnected\");\r\n            };\r\n            this._http.onreadystatechange = function () {\r\n                if (this.readyState == 2 && this.old) {\r\n                    this.old.abort();\r\n                    delete this.old;\r\n                }\r\n                else if (this.readyState > 2 &&\r\n                    this.status === 200 &&\r\n                    this.responseText) {\r\n                    self._handleStream(this);\r\n                }\r\n            };\r\n            this._http.send(null);\r\n            this._setHTTPTimeout();\r\n        }\r\n        catch (e) {\r\n            util_1.util.log(\"XMLHttpRequest not available; defaulting to WebSockets\");\r\n        }\r\n    };\r\n    Socket.prototype._handleStream = function (http) {\r\n        var messages = http.responseText.split(\"\\n\");\r\n        if (http._buffer) {\r\n            while (http._buffer.length > 0) {\r\n                var index = http._buffer.shift();\r\n                var bufferedMessage = messages[index];\r\n                try {\r\n                    bufferedMessage = JSON.parse(bufferedMessage);\r\n                }\r\n                catch (e) {\r\n                    http._buffer.shift(index);\r\n                    break;\r\n                }\r\n                this.emit(\"message\", bufferedMessage);\r\n            }\r\n        }\r\n        var message = messages[http._index];\r\n        if (message) {\r\n            http._index += 1;\r\n            if (http._index === messages.length) {\r\n                if (!http._buffer) {\r\n                    http._buffer = [];\r\n                }\r\n                http._buffer.push(http._index - 1);\r\n            }\r\n            else {\r\n                try {\r\n                    message = JSON.parse(message);\r\n                }\r\n                catch (e) {\r\n                    util_1.util.log(\"Invalid server message\", message);\r\n                    return;\r\n                }\r\n                this.emit(\"message\", message);\r\n            }\r\n        }\r\n    };\r\n    Socket.prototype._setHTTPTimeout = function () {\r\n        var self = this;\r\n        this._timeout = setTimeout(function () {\r\n            var old = self._http;\r\n            if (!self._wsOpen()) {\r\n                self._startXhrStream(old._streamIndex + 1);\r\n                self._http.old = old;\r\n            }\r\n            else {\r\n                old.abort();\r\n            }\r\n        }, 25000);\r\n    };\r\n    Socket.prototype._wsOpen = function () {\r\n        return this._socket && this._socket.readyState == 1;\r\n    };\r\n    Socket.prototype._sendQueuedMessages = function () {\r\n        for (var i = 0, ii = this._queue.length; i < ii; i += 1) {\r\n            this.send(this._queue[i]);\r\n        }\r\n    };\r\n    Socket.prototype.send = function (data) {\r\n        if (this.disconnected) {\r\n            return;\r\n        }\r\n        if (!this.id) {\r\n            this._queue.push(data);\r\n            return;\r\n        }\r\n        if (!data.type) {\r\n            this.emit(\"error\", \"Invalid message\");\r\n            return;\r\n        }\r\n        var message = JSON.stringify(data);\r\n        if (this._wsOpen()) {\r\n            this._socket.send(message);\r\n        }\r\n        else {\r\n            var http = new XMLHttpRequest();\r\n            var url = this._httpUrl + \"/\" + data.type.toLowerCase();\r\n            http.open(\"post\", url, true);\r\n            http.setRequestHeader(\"Content-Type\", \"application/json\");\r\n            http.send(message);\r\n        }\r\n    };\r\n    Socket.prototype.close = function () {\r\n        if (!this.disconnected && this._wsOpen()) {\r\n            this._socket.close();\r\n            this.disconnected = true;\r\n        }\r\n    };\r\n\r\n},{\"./util\":8,\"eventemitter3\":9}],8:[function(require,module,exports){\r\n    \"use strict\";\r\n    var __importDefault = (this && this.__importDefault) || function (mod) {\r\n        return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n    };\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    var defaultConfig = { iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }] };\r\n    var dataCount = 1;\r\n    var js_binarypack_1 = __importDefault(require(\"js-binarypack\"));\r\n    var adapter_1 = require(\"./adapter\");\r\n    exports.util = {\r\n        noop: function () { },\r\n        CLOUD_HOST: \"0.peerjs.com\",\r\n        CLOUD_PORT: 443,\r\n        chunkedBrowsers: { Chrome: 1 },\r\n        chunkedMTU: 16300,\r\n        logLevel: 0,\r\n        setLogLevel: function (level) {\r\n            var debugLevel = parseInt(level, 10);\r\n            if (!isNaN(parseInt(level, 10))) {\r\n                exports.util.logLevel = debugLevel;\r\n            }\r\n            else {\r\n                exports.util.logLevel = level ? 3 : 0;\r\n            }\r\n            exports.util.log = exports.util.warn = exports.util.error = exports.util.noop;\r\n            if (exports.util.logLevel > 0) {\r\n                exports.util.error = exports.util._printWith(\"ERROR\");\r\n            }\r\n            if (exports.util.logLevel > 1) {\r\n                exports.util.warn = exports.util._printWith(\"WARNING\");\r\n            }\r\n            if (exports.util.logLevel > 2) {\r\n                exports.util.log = exports.util._print;\r\n            }\r\n        },\r\n        setLogFunction: function (fn) {\r\n            if (fn.constructor !== Function) {\r\n                exports.util.warn(\"The log function you passed in is not a function. Defaulting to regular logs.\");\r\n            }\r\n            else {\r\n                exports.util._print = fn;\r\n            }\r\n        },\r\n        _printWith: function (prefix) {\r\n            return function () {\r\n                var copy = Array.prototype.slice.call(arguments);\r\n                copy.unshift(prefix);\r\n                exports.util._print.apply(exports.util, copy);\r\n            };\r\n        },\r\n        _print: function () {\r\n            var err = false;\r\n            var copy = Array.prototype.slice.call(arguments);\r\n            copy.unshift(\"PeerJS: \");\r\n            for (var i = 0, l = copy.length; i < l; i++) {\r\n                if (copy[i] instanceof Error) {\r\n                    copy[i] = \"(\" + copy[i].name + \") \" + copy[i].message;\r\n                    err = true;\r\n                }\r\n            }\r\n            err ? console.error.apply(console, copy) : console.log.apply(console, copy);\r\n        },\r\n        defaultConfig: defaultConfig,\r\n        browser: (function () {\r\n            if (window.mozRTCPeerConnection) {\r\n                return \"Firefox\";\r\n            }\r\n            else if (window.webkitRTCPeerConnection) {\r\n                return \"Chrome\";\r\n            }\r\n            else if (window.RTCPeerConnection) {\r\n                return \"Supported\";\r\n            }\r\n            else {\r\n                return \"Unsupported\";\r\n            }\r\n        })(),\r\n        supports: (function () {\r\n            if (typeof adapter_1.RTCPeerConnection === \"undefined\") {\r\n                return {};\r\n            }\r\n            var data = true;\r\n            var audioVideo = true;\r\n            var binaryBlob = false;\r\n            var sctp = false;\r\n            var onnegotiationneeded = !!window.webkitRTCPeerConnection;\r\n            var pc, dc;\r\n            try {\r\n                pc = new adapter_1.RTCPeerConnection(defaultConfig, {\r\n                    optional: [{ RtpDataChannels: true }]\r\n                });\r\n            }\r\n            catch (e) {\r\n                data = false;\r\n                audioVideo = false;\r\n            }\r\n            if (data) {\r\n                try {\r\n                    dc = pc.createDataChannel(\"_PEERJSTEST\");\r\n                }\r\n                catch (e) {\r\n                    data = false;\r\n                }\r\n            }\r\n            if (data) {\r\n                try {\r\n                    dc.binaryType = \"blob\";\r\n                    binaryBlob = true;\r\n                }\r\n                catch (e) { }\r\n                var reliablePC = new adapter_1.RTCPeerConnection(defaultConfig, {});\r\n                try {\r\n                    var reliableDC = reliablePC.createDataChannel(\"_PEERJSRELIABLETEST\", {});\r\n                    sctp = reliableDC.reliable;\r\n                }\r\n                catch (e) { }\r\n                reliablePC.close();\r\n            }\r\n            if (audioVideo) {\r\n                audioVideo = !!pc.addStream;\r\n            }\r\n            if (pc) {\r\n                pc.close();\r\n            }\r\n            return {\r\n                audioVideo: audioVideo,\r\n                data: data,\r\n                binaryBlob: binaryBlob,\r\n                binary: sctp,\r\n                reliable: sctp,\r\n                sctp: sctp,\r\n                onnegotiationneeded: onnegotiationneeded\r\n            };\r\n        })(),\r\n        validateId: function (id) {\r\n            return !id || /^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(id);\r\n        },\r\n        validateKey: function (key) {\r\n            return !key || /^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(key);\r\n        },\r\n        debug: false,\r\n        inherits: function (ctor, superCtor) {\r\n            ctor.super_ = superCtor;\r\n            ctor.prototype = Object.create(superCtor.prototype, {\r\n                constructor: {\r\n                    value: ctor,\r\n                    enumerable: false,\r\n                    writable: true,\r\n                    configurable: true\r\n                }\r\n            });\r\n        },\r\n        extend: function (dest, source) {\r\n            for (var key in source) {\r\n                if (source.hasOwnProperty(key)) {\r\n                    dest[key] = source[key];\r\n                }\r\n            }\r\n            return dest;\r\n        },\r\n        pack: js_binarypack_1.default.pack,\r\n        unpack: js_binarypack_1.default.unpack,\r\n        log: function () {\r\n            if (exports.util.debug) {\r\n                var err = false;\r\n                var copy = Array.prototype.slice.call(arguments);\r\n                copy.unshift(\"PeerJS: \");\r\n                for (var i = 0, l = copy.length; i < l; i++) {\r\n                    if (copy[i] instanceof Error) {\r\n                        copy[i] = \"(\" + copy[i].name + \") \" + copy[i].message;\r\n                        err = true;\r\n                    }\r\n                }\r\n                err\r\n                    ? console.error.apply(console, copy)\r\n                    : console.log.apply(console, copy);\r\n            }\r\n        },\r\n        setZeroTimeout: (function (global) {\r\n            var timeouts = [];\r\n            var messageName = \"zero-timeout-message\";\r\n            function setZeroTimeoutPostMessage(fn) {\r\n                timeouts.push(fn);\r\n                global.postMessage(messageName, \"*\");\r\n            }\r\n            function handleMessage(event) {\r\n                if (event.source == global && event.data == messageName) {\r\n                    if (event.stopPropagation) {\r\n                        event.stopPropagation();\r\n                    }\r\n                    if (timeouts.length) {\r\n                        timeouts.shift()();\r\n                    }\r\n                }\r\n            }\r\n            if (global.addEventListener) {\r\n                global.addEventListener(\"message\", handleMessage, true);\r\n            }\r\n            else if (global.attachEvent) {\r\n                global.attachEvent(\"onmessage\", handleMessage);\r\n            }\r\n            return setZeroTimeoutPostMessage;\r\n        })(window),\r\n        chunk: function (bl) {\r\n            var chunks = [];\r\n            var size = bl.size;\r\n            var index;\r\n            var start = (index = 0);\r\n            var total = Math.ceil(size / exports.util.chunkedMTU);\r\n            while (start < size) {\r\n                var end = Math.min(size, start + exports.util.chunkedMTU);\r\n                var b = bl.slice(start, end);\r\n                var chunk = {\r\n                    __peerData: dataCount,\r\n                    n: index,\r\n                    data: b,\r\n                    total: total\r\n                };\r\n                chunks.push(chunk);\r\n                start = end;\r\n                index += 1;\r\n            }\r\n            dataCount += 1;\r\n            return chunks;\r\n        },\r\n        blobToArrayBuffer: function (blob, cb) {\r\n            var fr = new FileReader();\r\n            fr.onload = function (evt) {\r\n                cb(evt.target.result);\r\n            };\r\n            fr.readAsArrayBuffer(blob);\r\n        },\r\n        blobToBinaryString: function (blob, cb) {\r\n            var fr = new FileReader();\r\n            fr.onload = function (evt) {\r\n                cb(evt.target.result);\r\n            };\r\n            fr.readAsBinaryString(blob);\r\n        },\r\n        binaryStringToArrayBuffer: function (binary) {\r\n            var byteArray = new Uint8Array(binary.length);\r\n            for (var i = 0; i < binary.length; i++) {\r\n                byteArray[i] = binary.charCodeAt(i) & 0xff;\r\n            }\r\n            return byteArray.buffer;\r\n        },\r\n        randomToken: function () {\r\n            return Math.random()\r\n                .toString(36)\r\n                .substr(2);\r\n        },\r\n        isSecure: function () {\r\n            return location.protocol === \"https:\";\r\n        }\r\n    };\r\n\r\n},{\"./adapter\":1,\"js-binarypack\":10}],9:[function(require,module,exports){\r\n    'use strict';\r\n\r\n    /**\r\n     * Representation of a single EventEmitter function.\r\n     *\r\n     * @param {Function} fn Event handler to be called.\r\n     * @param {Mixed} context Context for function execution.\r\n     * @param {Boolean} once Only emit once\r\n     * @api private\r\n     */\r\n    function EE(fn, context, once) {\r\n        this.fn = fn;\r\n        this.context = context;\r\n        this.once = once || false;\r\n    }\r\n\r\n    /**\r\n     * Minimal EventEmitter interface that is molded against the Node.js\r\n     * EventEmitter interface.\r\n     *\r\n     * @constructor\r\n     * @api public\r\n     */\r\n    function EventEmitter() { /* Nothing to set */ }\r\n\r\n    /**\r\n     * Holds the assigned EventEmitters by name.\r\n     *\r\n     * @type {Object}\r\n     * @private\r\n     */\r\n    EventEmitter.prototype._events = undefined;\r\n\r\n    /**\r\n     * Return a list of assigned event listeners.\r\n     *\r\n     * @param {String} event The events that should be listed.\r\n     * @returns {Array}\r\n     * @api public\r\n     */\r\n    EventEmitter.prototype.listeners = function listeners(event) {\r\n        if (!this._events || !this._events[event]) return [];\r\n        if (this._events[event].fn) return [this._events[event].fn];\r\n\r\n        for (var i = 0, l = this._events[event].length, ee = new Array(l); i < l; i++) {\r\n            ee[i] = this._events[event][i].fn;\r\n        }\r\n\r\n        return ee;\r\n    };\r\n\r\n    /**\r\n     * Emit an event to all registered event listeners.\r\n     *\r\n     * @param {String} event The name of the event.\r\n     * @returns {Boolean} Indication if we've emitted an event.\r\n     * @api public\r\n     */\r\n    EventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {\r\n        if (!this._events || !this._events[event]) return false;\r\n\r\n        var listeners = this._events[event]\r\n            , len = arguments.length\r\n            , args\r\n            , i;\r\n\r\n        if ('function' === typeof listeners.fn) {\r\n            if (listeners.once) this.removeListener(event, listeners.fn, true);\r\n\r\n            switch (len) {\r\n                case 1: return listeners.fn.call(listeners.context), true;\r\n                case 2: return listeners.fn.call(listeners.context, a1), true;\r\n                case 3: return listeners.fn.call(listeners.context, a1, a2), true;\r\n                case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;\r\n                case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;\r\n                case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;\r\n            }\r\n\r\n            for (i = 1, args = new Array(len -1); i < len; i++) {\r\n                args[i - 1] = arguments[i];\r\n            }\r\n\r\n            listeners.fn.apply(listeners.context, args);\r\n        } else {\r\n            var length = listeners.length\r\n                , j;\r\n\r\n            for (i = 0; i < length; i++) {\r\n                if (listeners[i].once) this.removeListener(event, listeners[i].fn, true);\r\n\r\n                switch (len) {\r\n                    case 1: listeners[i].fn.call(listeners[i].context); break;\r\n                    case 2: listeners[i].fn.call(listeners[i].context, a1); break;\r\n                    case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;\r\n                    default:\r\n                        if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {\r\n                            args[j - 1] = arguments[j];\r\n                        }\r\n\r\n                        listeners[i].fn.apply(listeners[i].context, args);\r\n                }\r\n            }\r\n        }\r\n\r\n        return true;\r\n    };\r\n\r\n    /**\r\n     * Register a new EventListener for the given event.\r\n     *\r\n     * @param {String} event Name of the event.\r\n     * @param {Functon} fn Callback function.\r\n     * @param {Mixed} context The context of the function.\r\n     * @api public\r\n     */\r\n    EventEmitter.prototype.on = function on(event, fn, context) {\r\n        var listener = new EE(fn, context || this);\r\n\r\n        if (!this._events) this._events = {};\r\n        if (!this._events[event]) this._events[event] = listener;\r\n        else {\r\n            if (!this._events[event].fn) this._events[event].push(listener);\r\n            else this._events[event] = [\r\n                this._events[event], listener\r\n            ];\r\n        }\r\n\r\n        return this;\r\n    };\r\n\r\n    /**\r\n     * Add an EventListener that's only called once.\r\n     *\r\n     * @param {String} event Name of the event.\r\n     * @param {Function} fn Callback function.\r\n     * @param {Mixed} context The context of the function.\r\n     * @api public\r\n     */\r\n    EventEmitter.prototype.once = function once(event, fn, context) {\r\n        var listener = new EE(fn, context || this, true);\r\n\r\n        if (!this._events) this._events = {};\r\n        if (!this._events[event]) this._events[event] = listener;\r\n        else {\r\n            if (!this._events[event].fn) this._events[event].push(listener);\r\n            else this._events[event] = [\r\n                this._events[event], listener\r\n            ];\r\n        }\r\n\r\n        return this;\r\n    };\r\n\r\n    /**\r\n     * Remove event listeners.\r\n     *\r\n     * @param {String} event The event we want to remove.\r\n     * @param {Function} fn The listener that we need to find.\r\n     * @param {Boolean} once Only remove once listeners.\r\n     * @api public\r\n     */\r\n    EventEmitter.prototype.removeListener = function removeListener(event, fn, once) {\r\n        if (!this._events || !this._events[event]) return this;\r\n\r\n        var listeners = this._events[event]\r\n            , events = [];\r\n\r\n        if (fn) {\r\n            if (listeners.fn && (listeners.fn !== fn || (once && !listeners.once))) {\r\n                events.push(listeners);\r\n            }\r\n            if (!listeners.fn) for (var i = 0, length = listeners.length; i < length; i++) {\r\n                if (listeners[i].fn !== fn || (once && !listeners[i].once)) {\r\n                    events.push(listeners[i]);\r\n                }\r\n            }\r\n        }\r\n\r\n        //\r\n        // Reset the array, or remove it completely if we have no more listeners.\r\n        //\r\n        if (events.length) {\r\n            this._events[event] = events.length === 1 ? events[0] : events;\r\n        } else {\r\n            delete this._events[event];\r\n        }\r\n\r\n        return this;\r\n    };\r\n\r\n    /**\r\n     * Remove all listeners or only the listeners for the specified event.\r\n     *\r\n     * @param {String} event The event want to remove all listeners for.\r\n     * @api public\r\n     */\r\n    EventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {\r\n        if (!this._events) return this;\r\n\r\n        if (event) delete this._events[event];\r\n        else this._events = {};\r\n\r\n        return this;\r\n    };\r\n\r\n//\r\n// Alias methods names because people roll like that.\r\n//\r\n    EventEmitter.prototype.off = EventEmitter.prototype.removeListener;\r\n    EventEmitter.prototype.addListener = EventEmitter.prototype.on;\r\n\r\n//\r\n// This function doesn't apply anymore.\r\n//\r\n    EventEmitter.prototype.setMaxListeners = function setMaxListeners() {\r\n        return this;\r\n    };\r\n\r\n//\r\n// Expose the module.\r\n//\r\n    EventEmitter.EventEmitter = EventEmitter;\r\n    EventEmitter.EventEmitter2 = EventEmitter;\r\n    EventEmitter.EventEmitter3 = EventEmitter;\r\n\r\n//\r\n// Expose the module.\r\n//\r\n    module.exports = EventEmitter;\r\n\r\n},{}],10:[function(require,module,exports){\r\n    var BufferBuilder = require('./bufferbuilder').BufferBuilder;\r\n    var binaryFeatures = require('./bufferbuilder').binaryFeatures;\r\n\r\n    var BinaryPack = {\r\n        unpack: function(data){\r\n            var unpacker = new Unpacker(data);\r\n            return unpacker.unpack();\r\n        },\r\n        pack: function(data){\r\n            var packer = new Packer();\r\n            packer.pack(data);\r\n            var buffer = packer.getBuffer();\r\n            return buffer;\r\n        }\r\n    };\r\n\r\n    module.exports = BinaryPack;\r\n\r\n    function Unpacker (data){\r\n        // Data is ArrayBuffer\r\n        this.index = 0;\r\n        this.dataBuffer = data;\r\n        this.dataView = new Uint8Array(this.dataBuffer);\r\n        this.length = this.dataBuffer.byteLength;\r\n    }\r\n\r\n    Unpacker.prototype.unpack = function(){\r\n        var type = this.unpack_uint8();\r\n        if (type < 0x80){\r\n            var positive_fixnum = type;\r\n            return positive_fixnum;\r\n        } else if ((type ^ 0xe0) < 0x20){\r\n            var negative_fixnum = (type ^ 0xe0) - 0x20;\r\n            return negative_fixnum;\r\n        }\r\n        var size;\r\n        if ((size = type ^ 0xa0) <= 0x0f){\r\n            return this.unpack_raw(size);\r\n        } else if ((size = type ^ 0xb0) <= 0x0f){\r\n            return this.unpack_string(size);\r\n        } else if ((size = type ^ 0x90) <= 0x0f){\r\n            return this.unpack_array(size);\r\n        } else if ((size = type ^ 0x80) <= 0x0f){\r\n            return this.unpack_map(size);\r\n        }\r\n        switch(type){\r\n            case 0xc0:\r\n                return null;\r\n            case 0xc1:\r\n                return undefined;\r\n            case 0xc2:\r\n                return false;\r\n            case 0xc3:\r\n                return true;\r\n            case 0xca:\r\n                return this.unpack_float();\r\n            case 0xcb:\r\n                return this.unpack_double();\r\n            case 0xcc:\r\n                return this.unpack_uint8();\r\n            case 0xcd:\r\n                return this.unpack_uint16();\r\n            case 0xce:\r\n                return this.unpack_uint32();\r\n            case 0xcf:\r\n                return this.unpack_uint64();\r\n            case 0xd0:\r\n                return this.unpack_int8();\r\n            case 0xd1:\r\n                return this.unpack_int16();\r\n            case 0xd2:\r\n                return this.unpack_int32();\r\n            case 0xd3:\r\n                return this.unpack_int64();\r\n            case 0xd4:\r\n                return undefined;\r\n            case 0xd5:\r\n                return undefined;\r\n            case 0xd6:\r\n                return undefined;\r\n            case 0xd7:\r\n                return undefined;\r\n            case 0xd8:\r\n                size = this.unpack_uint16();\r\n                return this.unpack_string(size);\r\n            case 0xd9:\r\n                size = this.unpack_uint32();\r\n                return this.unpack_string(size);\r\n            case 0xda:\r\n                size = this.unpack_uint16();\r\n                return this.unpack_raw(size);\r\n            case 0xdb:\r\n                size = this.unpack_uint32();\r\n                return this.unpack_raw(size);\r\n            case 0xdc:\r\n                size = this.unpack_uint16();\r\n                return this.unpack_array(size);\r\n            case 0xdd:\r\n                size = this.unpack_uint32();\r\n                return this.unpack_array(size);\r\n            case 0xde:\r\n                size = this.unpack_uint16();\r\n                return this.unpack_map(size);\r\n            case 0xdf:\r\n                size = this.unpack_uint32();\r\n                return this.unpack_map(size);\r\n        }\r\n    }\r\n\r\n    Unpacker.prototype.unpack_uint8 = function(){\r\n        var byte = this.dataView[this.index] & 0xff;\r\n        this.index++;\r\n        return byte;\r\n    };\r\n\r\n    Unpacker.prototype.unpack_uint16 = function(){\r\n        var bytes = this.read(2);\r\n        var uint16 =\r\n            ((bytes[0] & 0xff) * 256) + (bytes[1] & 0xff);\r\n        this.index += 2;\r\n        return uint16;\r\n    }\r\n\r\n    Unpacker.prototype.unpack_uint32 = function(){\r\n        var bytes = this.read(4);\r\n        var uint32 =\r\n            ((bytes[0]  * 256 +\r\n                bytes[1]) * 256 +\r\n                bytes[2]) * 256 +\r\n            bytes[3];\r\n        this.index += 4;\r\n        return uint32;\r\n    }\r\n\r\n    Unpacker.prototype.unpack_uint64 = function(){\r\n        var bytes = this.read(8);\r\n        var uint64 =\r\n            ((((((bytes[0]  * 256 +\r\n                bytes[1]) * 256 +\r\n                bytes[2]) * 256 +\r\n                bytes[3]) * 256 +\r\n                bytes[4]) * 256 +\r\n                bytes[5]) * 256 +\r\n                bytes[6]) * 256 +\r\n            bytes[7];\r\n        this.index += 8;\r\n        return uint64;\r\n    }\r\n\r\n\r\n    Unpacker.prototype.unpack_int8 = function(){\r\n        var uint8 = this.unpack_uint8();\r\n        return (uint8 < 0x80 ) ? uint8 : uint8 - (1 << 8);\r\n    };\r\n\r\n    Unpacker.prototype.unpack_int16 = function(){\r\n        var uint16 = this.unpack_uint16();\r\n        return (uint16 < 0x8000 ) ? uint16 : uint16 - (1 << 16);\r\n    }\r\n\r\n    Unpacker.prototype.unpack_int32 = function(){\r\n        var uint32 = this.unpack_uint32();\r\n        return (uint32 < Math.pow(2, 31) ) ? uint32 :\r\n            uint32 - Math.pow(2, 32);\r\n    }\r\n\r\n    Unpacker.prototype.unpack_int64 = function(){\r\n        var uint64 = this.unpack_uint64();\r\n        return (uint64 < Math.pow(2, 63) ) ? uint64 :\r\n            uint64 - Math.pow(2, 64);\r\n    }\r\n\r\n    Unpacker.prototype.unpack_raw = function(size){\r\n        if ( this.length < this.index + size){\r\n            throw new Error('BinaryPackFailure: index is out of range'\r\n                + ' ' + this.index + ' ' + size + ' ' + this.length);\r\n        }\r\n        var buf = this.dataBuffer.slice(this.index, this.index + size);\r\n        this.index += size;\r\n\r\n        //buf = util.bufferToString(buf);\r\n\r\n        return buf;\r\n    }\r\n\r\n    Unpacker.prototype.unpack_string = function(size){\r\n        var bytes = this.read(size);\r\n        var i = 0, str = '', c, code;\r\n        while(i < size){\r\n            c = bytes[i];\r\n            if ( c < 128){\r\n                str += String.fromCharCode(c);\r\n                i++;\r\n            } else if ((c ^ 0xc0) < 32){\r\n                code = ((c ^ 0xc0) << 6) | (bytes[i+1] & 63);\r\n                str += String.fromCharCode(code);\r\n                i += 2;\r\n            } else {\r\n                code = ((c & 15) << 12) | ((bytes[i+1] & 63) << 6) |\r\n                    (bytes[i+2] & 63);\r\n                str += String.fromCharCode(code);\r\n                i += 3;\r\n            }\r\n        }\r\n        this.index += size;\r\n        return str;\r\n    }\r\n\r\n    Unpacker.prototype.unpack_array = function(size){\r\n        var objects = new Array(size);\r\n        for(var i = 0; i < size ; i++){\r\n            objects[i] = this.unpack();\r\n        }\r\n        return objects;\r\n    }\r\n\r\n    Unpacker.prototype.unpack_map = function(size){\r\n        var map = {};\r\n        for(var i = 0; i < size ; i++){\r\n            var key  = this.unpack();\r\n            var value = this.unpack();\r\n            map[key] = value;\r\n        }\r\n        return map;\r\n    }\r\n\r\n    Unpacker.prototype.unpack_float = function(){\r\n        var uint32 = this.unpack_uint32();\r\n        var sign = uint32 >> 31;\r\n        var exp  = ((uint32 >> 23) & 0xff) - 127;\r\n        var fraction = ( uint32 & 0x7fffff ) | 0x800000;\r\n        return (sign == 0 ? 1 : -1) *\r\n            fraction * Math.pow(2, exp - 23);\r\n    }\r\n\r\n    Unpacker.prototype.unpack_double = function(){\r\n        var h32 = this.unpack_uint32();\r\n        var l32 = this.unpack_uint32();\r\n        var sign = h32 >> 31;\r\n        var exp  = ((h32 >> 20) & 0x7ff) - 1023;\r\n        var hfrac = ( h32 & 0xfffff ) | 0x100000;\r\n        var frac = hfrac * Math.pow(2, exp - 20) +\r\n            l32   * Math.pow(2, exp - 52);\r\n        return (sign == 0 ? 1 : -1) * frac;\r\n    }\r\n\r\n    Unpacker.prototype.read = function(length){\r\n        var j = this.index;\r\n        if (j + length <= this.length) {\r\n            return this.dataView.subarray(j, j + length);\r\n        } else {\r\n            throw new Error('BinaryPackFailure: read index out of range');\r\n        }\r\n    }\r\n\r\n    function Packer(){\r\n        this.bufferBuilder = new BufferBuilder();\r\n    }\r\n\r\n    Packer.prototype.getBuffer = function(){\r\n        return this.bufferBuilder.getBuffer();\r\n    }\r\n\r\n    Packer.prototype.pack = function(value){\r\n        var type = typeof(value);\r\n        if (type == 'string'){\r\n            this.pack_string(value);\r\n        } else if (type == 'number'){\r\n            if (Math.floor(value) === value){\r\n                this.pack_integer(value);\r\n            } else{\r\n                this.pack_double(value);\r\n            }\r\n        } else if (type == 'boolean'){\r\n            if (value === true){\r\n                this.bufferBuilder.append(0xc3);\r\n            } else if (value === false){\r\n                this.bufferBuilder.append(0xc2);\r\n            }\r\n        } else if (type == 'undefined'){\r\n            this.bufferBuilder.append(0xc0);\r\n        } else if (type == 'object'){\r\n            if (value === null){\r\n                this.bufferBuilder.append(0xc0);\r\n            } else {\r\n                var constructor = value.constructor;\r\n                if (constructor == Array){\r\n                    this.pack_array(value);\r\n                } else if (constructor == Blob || constructor == File) {\r\n                    this.pack_bin(value);\r\n                } else if (constructor == ArrayBuffer) {\r\n                    if(binaryFeatures.useArrayBufferView) {\r\n                        this.pack_bin(new Uint8Array(value));\r\n                    } else {\r\n                        this.pack_bin(value);\r\n                    }\r\n                } else if ('BYTES_PER_ELEMENT' in value){\r\n                    if(binaryFeatures.useArrayBufferView) {\r\n                        this.pack_bin(new Uint8Array(value.buffer));\r\n                    } else {\r\n                        this.pack_bin(value.buffer);\r\n                    }\r\n                } else if (constructor == Object){\r\n                    this.pack_object(value);\r\n                } else if (constructor == Date){\r\n                    this.pack_string(value.toString());\r\n                } else if (typeof value.toBinaryPack == 'function'){\r\n                    this.bufferBuilder.append(value.toBinaryPack());\r\n                } else {\r\n                    throw new Error('Type \"' + constructor.toString() + '\" not yet supported');\r\n                }\r\n            }\r\n        } else {\r\n            throw new Error('Type \"' + type + '\" not yet supported');\r\n        }\r\n        this.bufferBuilder.flush();\r\n    }\r\n\r\n\r\n    Packer.prototype.pack_bin = function(blob){\r\n        var length = blob.length || blob.byteLength || blob.size;\r\n        if (length <= 0x0f){\r\n            this.pack_uint8(0xa0 + length);\r\n        } else if (length <= 0xffff){\r\n            this.bufferBuilder.append(0xda) ;\r\n            this.pack_uint16(length);\r\n        } else if (length <= 0xffffffff){\r\n            this.bufferBuilder.append(0xdb);\r\n            this.pack_uint32(length);\r\n        } else{\r\n            throw new Error('Invalid length');\r\n        }\r\n        this.bufferBuilder.append(blob);\r\n    }\r\n\r\n    Packer.prototype.pack_string = function(str){\r\n        var length = utf8Length(str);\r\n\r\n        if (length <= 0x0f){\r\n            this.pack_uint8(0xb0 + length);\r\n        } else if (length <= 0xffff){\r\n            this.bufferBuilder.append(0xd8) ;\r\n            this.pack_uint16(length);\r\n        } else if (length <= 0xffffffff){\r\n            this.bufferBuilder.append(0xd9);\r\n            this.pack_uint32(length);\r\n        } else{\r\n            throw new Error('Invalid length');\r\n        }\r\n        this.bufferBuilder.append(str);\r\n    }\r\n\r\n    Packer.prototype.pack_array = function(ary){\r\n        var length = ary.length;\r\n        if (length <= 0x0f){\r\n            this.pack_uint8(0x90 + length);\r\n        } else if (length <= 0xffff){\r\n            this.bufferBuilder.append(0xdc)\r\n            this.pack_uint16(length);\r\n        } else if (length <= 0xffffffff){\r\n            this.bufferBuilder.append(0xdd);\r\n            this.pack_uint32(length);\r\n        } else{\r\n            throw new Error('Invalid length');\r\n        }\r\n        for(var i = 0; i < length ; i++){\r\n            this.pack(ary[i]);\r\n        }\r\n    }\r\n\r\n    Packer.prototype.pack_integer = function(num){\r\n        if ( -0x20 <= num && num <= 0x7f){\r\n            this.bufferBuilder.append(num & 0xff);\r\n        } else if (0x00 <= num && num <= 0xff){\r\n            this.bufferBuilder.append(0xcc);\r\n            this.pack_uint8(num);\r\n        } else if (-0x80 <= num && num <= 0x7f){\r\n            this.bufferBuilder.append(0xd0);\r\n            this.pack_int8(num);\r\n        } else if ( 0x0000 <= num && num <= 0xffff){\r\n            this.bufferBuilder.append(0xcd);\r\n            this.pack_uint16(num);\r\n        } else if (-0x8000 <= num && num <= 0x7fff){\r\n            this.bufferBuilder.append(0xd1);\r\n            this.pack_int16(num);\r\n        } else if ( 0x00000000 <= num && num <= 0xffffffff){\r\n            this.bufferBuilder.append(0xce);\r\n            this.pack_uint32(num);\r\n        } else if (-0x80000000 <= num && num <= 0x7fffffff){\r\n            this.bufferBuilder.append(0xd2);\r\n            this.pack_int32(num);\r\n        } else if (-0x8000000000000000 <= num && num <= 0x7FFFFFFFFFFFFFFF){\r\n            this.bufferBuilder.append(0xd3);\r\n            this.pack_int64(num);\r\n        } else if (0x0000000000000000 <= num && num <= 0xFFFFFFFFFFFFFFFF){\r\n            this.bufferBuilder.append(0xcf);\r\n            this.pack_uint64(num);\r\n        } else{\r\n            throw new Error('Invalid integer');\r\n        }\r\n    }\r\n\r\n    Packer.prototype.pack_double = function(num){\r\n        var sign = 0;\r\n        if (num < 0){\r\n            sign = 1;\r\n            num = -num;\r\n        }\r\n        var exp  = Math.floor(Math.log(num) / Math.LN2);\r\n        var frac0 = num / Math.pow(2, exp) - 1;\r\n        var frac1 = Math.floor(frac0 * Math.pow(2, 52));\r\n        var b32   = Math.pow(2, 32);\r\n        var h32 = (sign << 31) | ((exp+1023) << 20) |\r\n            (frac1 / b32) & 0x0fffff;\r\n        var l32 = frac1 % b32;\r\n        this.bufferBuilder.append(0xcb);\r\n        this.pack_int32(h32);\r\n        this.pack_int32(l32);\r\n    }\r\n\r\n    Packer.prototype.pack_object = function(obj){\r\n        var keys = Object.keys(obj);\r\n        var length = keys.length;\r\n        if (length <= 0x0f){\r\n            this.pack_uint8(0x80 + length);\r\n        } else if (length <= 0xffff){\r\n            this.bufferBuilder.append(0xde);\r\n            this.pack_uint16(length);\r\n        } else if (length <= 0xffffffff){\r\n            this.bufferBuilder.append(0xdf);\r\n            this.pack_uint32(length);\r\n        } else{\r\n            throw new Error('Invalid length');\r\n        }\r\n        for(var prop in obj){\r\n            if (obj.hasOwnProperty(prop)){\r\n                this.pack(prop);\r\n                this.pack(obj[prop]);\r\n            }\r\n        }\r\n    }\r\n\r\n    Packer.prototype.pack_uint8 = function(num){\r\n        this.bufferBuilder.append(num);\r\n    }\r\n\r\n    Packer.prototype.pack_uint16 = function(num){\r\n        this.bufferBuilder.append(num >> 8);\r\n        this.bufferBuilder.append(num & 0xff);\r\n    }\r\n\r\n    Packer.prototype.pack_uint32 = function(num){\r\n        var n = num & 0xffffffff;\r\n        this.bufferBuilder.append((n & 0xff000000) >>> 24);\r\n        this.bufferBuilder.append((n & 0x00ff0000) >>> 16);\r\n        this.bufferBuilder.append((n & 0x0000ff00) >>>  8);\r\n        this.bufferBuilder.append((n & 0x000000ff));\r\n    }\r\n\r\n    Packer.prototype.pack_uint64 = function(num){\r\n        var high = num / Math.pow(2, 32);\r\n        var low  = num % Math.pow(2, 32);\r\n        this.bufferBuilder.append((high & 0xff000000) >>> 24);\r\n        this.bufferBuilder.append((high & 0x00ff0000) >>> 16);\r\n        this.bufferBuilder.append((high & 0x0000ff00) >>>  8);\r\n        this.bufferBuilder.append((high & 0x000000ff));\r\n        this.bufferBuilder.append((low  & 0xff000000) >>> 24);\r\n        this.bufferBuilder.append((low  & 0x00ff0000) >>> 16);\r\n        this.bufferBuilder.append((low  & 0x0000ff00) >>>  8);\r\n        this.bufferBuilder.append((low  & 0x000000ff));\r\n    }\r\n\r\n    Packer.prototype.pack_int8 = function(num){\r\n        this.bufferBuilder.append(num & 0xff);\r\n    }\r\n\r\n    Packer.prototype.pack_int16 = function(num){\r\n        this.bufferBuilder.append((num & 0xff00) >> 8);\r\n        this.bufferBuilder.append(num & 0xff);\r\n    }\r\n\r\n    Packer.prototype.pack_int32 = function(num){\r\n        this.bufferBuilder.append((num >>> 24) & 0xff);\r\n        this.bufferBuilder.append((num & 0x00ff0000) >>> 16);\r\n        this.bufferBuilder.append((num & 0x0000ff00) >>> 8);\r\n        this.bufferBuilder.append((num & 0x000000ff));\r\n    }\r\n\r\n    Packer.prototype.pack_int64 = function(num){\r\n        var high = Math.floor(num / Math.pow(2, 32));\r\n        var low  = num % Math.pow(2, 32);\r\n        this.bufferBuilder.append((high & 0xff000000) >>> 24);\r\n        this.bufferBuilder.append((high & 0x00ff0000) >>> 16);\r\n        this.bufferBuilder.append((high & 0x0000ff00) >>>  8);\r\n        this.bufferBuilder.append((high & 0x000000ff));\r\n        this.bufferBuilder.append((low  & 0xff000000) >>> 24);\r\n        this.bufferBuilder.append((low  & 0x00ff0000) >>> 16);\r\n        this.bufferBuilder.append((low  & 0x0000ff00) >>>  8);\r\n        this.bufferBuilder.append((low  & 0x000000ff));\r\n    }\r\n\r\n    function _utf8Replace(m){\r\n        var code = m.charCodeAt(0);\r\n\r\n        if(code <= 0x7ff) return '00';\r\n        if(code <= 0xffff) return '000';\r\n        if(code <= 0x1fffff) return '0000';\r\n        if(code <= 0x3ffffff) return '00000';\r\n        return '000000';\r\n    }\r\n\r\n    function utf8Length(str){\r\n        if (str.length > 600) {\r\n            // Blob method faster for large strings\r\n            return (new Blob([str])).size;\r\n        } else {\r\n            return str.replace(/[^\\u0000-\\u007F]/g, _utf8Replace).length;\r\n        }\r\n    }\r\n\r\n},{\"./bufferbuilder\":11}],11:[function(require,module,exports){\r\n    var binaryFeatures = {};\r\n    binaryFeatures.useBlobBuilder = (function(){\r\n        try {\r\n            new Blob([]);\r\n            return false;\r\n        } catch (e) {\r\n            return true;\r\n        }\r\n    })();\r\n\r\n    binaryFeatures.useArrayBufferView = !binaryFeatures.useBlobBuilder && (function(){\r\n        try {\r\n            return (new Blob([new Uint8Array([])])).size === 0;\r\n        } catch (e) {\r\n            return true;\r\n        }\r\n    })();\r\n\r\n    module.exports.binaryFeatures = binaryFeatures;\r\n    var BlobBuilder = module.exports.BlobBuilder;\r\n    if (typeof window != 'undefined') {\r\n        BlobBuilder = module.exports.BlobBuilder = window.WebKitBlobBuilder ||\r\n            window.MozBlobBuilder || window.MSBlobBuilder || window.BlobBuilder;\r\n    }\r\n\r\n    function BufferBuilder(){\r\n        this._pieces = [];\r\n        this._parts = [];\r\n    }\r\n\r\n    BufferBuilder.prototype.append = function(data) {\r\n        if(typeof data === 'number') {\r\n            this._pieces.push(data);\r\n        } else {\r\n            this.flush();\r\n            this._parts.push(data);\r\n        }\r\n    };\r\n\r\n    BufferBuilder.prototype.flush = function() {\r\n        if (this._pieces.length > 0) {\r\n            var buf = new Uint8Array(this._pieces);\r\n            if(!binaryFeatures.useArrayBufferView) {\r\n                buf = buf.buffer;\r\n            }\r\n            this._parts.push(buf);\r\n            this._pieces = [];\r\n        }\r\n    };\r\n\r\n    BufferBuilder.prototype.getBuffer = function() {\r\n        this.flush();\r\n        if(binaryFeatures.useBlobBuilder) {\r\n            var builder = new BlobBuilder();\r\n            for(var i = 0, ii = this._parts.length; i < ii; i++) {\r\n                builder.append(this._parts[i]);\r\n            }\r\n            return builder.getBlob();\r\n        } else {\r\n            return new Blob(this._parts);\r\n        }\r\n    };\r\n\r\n    module.exports.BufferBuilder = BufferBuilder;\r\n\r\n},{}],12:[function(require,module,exports){\r\n    var util = require('./util');\r\n\r\n    /**\r\n     * Reliable transfer for Chrome Canary DataChannel impl.\r\n     * Author: @michellebu\r\n     */\r\n    function Reliable(dc, debug) {\r\n        if (!(this instanceof Reliable)) return new Reliable(dc);\r\n        this._dc = dc;\r\n\r\n        util.debug = debug;\r\n\r\n        // Messages sent/received so far.\r\n        // id: { ack: n, chunks: [...] }\r\n        this._outgoing = {};\r\n        // id: { ack: ['ack', id, n], chunks: [...] }\r\n        this._incoming = {};\r\n        this._received = {};\r\n\r\n        // Window size.\r\n        this._window = 1000;\r\n        // MTU.\r\n        this._mtu = 500;\r\n        // Interval for setInterval. In ms.\r\n        this._interval = 0;\r\n\r\n        // Messages sent.\r\n        this._count = 0;\r\n\r\n        // Outgoing message queue.\r\n        this._queue = [];\r\n\r\n        this._setupDC();\r\n    };\r\n\r\n// Send a message reliably.\r\n    Reliable.prototype.send = function(msg) {\r\n        // Determine if chunking is necessary.\r\n        var bl = util.pack(msg);\r\n        if (bl.size < this._mtu) {\r\n            this._handleSend(['no', bl]);\r\n            return;\r\n        }\r\n\r\n        this._outgoing[this._count] = {\r\n            ack: 0,\r\n            chunks: this._chunk(bl)\r\n        };\r\n\r\n        if (util.debug) {\r\n            this._outgoing[this._count].timer = new Date();\r\n        }\r\n\r\n        // Send prelim window.\r\n        this._sendWindowedChunks(this._count);\r\n        this._count += 1;\r\n    };\r\n\r\n// Set up interval for processing queue.\r\n    Reliable.prototype._setupInterval = function() {\r\n        // TODO: fail gracefully.\r\n\r\n        var self = this;\r\n        this._timeout = setInterval(function() {\r\n            // FIXME: String stuff makes things terribly async.\r\n            var msg = self._queue.shift();\r\n            if (msg._multiple) {\r\n                for (var i = 0, ii = msg.length; i < ii; i += 1) {\r\n                    self._intervalSend(msg[i]);\r\n                }\r\n            } else {\r\n                self._intervalSend(msg);\r\n            }\r\n        }, this._interval);\r\n    };\r\n\r\n    Reliable.prototype._intervalSend = function(msg) {\r\n        var self = this;\r\n        msg = util.pack(msg);\r\n        util.blobToBinaryString(msg, function(str) {\r\n            self._dc.send(str);\r\n        });\r\n        if (self._queue.length === 0) {\r\n            clearTimeout(self._timeout);\r\n            self._timeout = null;\r\n            //self._processAcks();\r\n        }\r\n    };\r\n\r\n// Go through ACKs to send missing pieces.\r\n    Reliable.prototype._processAcks = function() {\r\n        for (var id in this._outgoing) {\r\n            if (this._outgoing.hasOwnProperty(id)) {\r\n                this._sendWindowedChunks(id);\r\n            }\r\n        }\r\n    };\r\n\r\n// Handle sending a message.\r\n// FIXME: Don't wait for interval time for all messages...\r\n    Reliable.prototype._handleSend = function(msg) {\r\n        var push = true;\r\n        for (var i = 0, ii = this._queue.length; i < ii; i += 1) {\r\n            var item = this._queue[i];\r\n            if (item === msg) {\r\n                push = false;\r\n            } else if (item._multiple && item.indexOf(msg) !== -1) {\r\n                push = false;\r\n            }\r\n        }\r\n        if (push) {\r\n            this._queue.push(msg);\r\n            if (!this._timeout) {\r\n                this._setupInterval();\r\n            }\r\n        }\r\n    };\r\n\r\n// Set up DataChannel handlers.\r\n    Reliable.prototype._setupDC = function() {\r\n        // Handle various message types.\r\n        var self = this;\r\n        this._dc.onmessage = function(e) {\r\n            var msg = e.data;\r\n            var datatype = msg.constructor;\r\n            // FIXME: msg is String until binary is supported.\r\n            // Once that happens, this will have to be smarter.\r\n            if (datatype === String) {\r\n                var ab = util.binaryStringToArrayBuffer(msg);\r\n                msg = util.unpack(ab);\r\n                self._handleMessage(msg);\r\n            }\r\n        };\r\n    };\r\n\r\n// Handles an incoming message.\r\n    Reliable.prototype._handleMessage = function(msg) {\r\n        var id = msg[1];\r\n        var idata = this._incoming[id];\r\n        var odata = this._outgoing[id];\r\n        var data;\r\n        switch (msg[0]) {\r\n            // No chunking was done.\r\n            case 'no':\r\n                var message = id;\r\n                if (!!message) {\r\n                    this.onmessage(util.unpack(message));\r\n                }\r\n                break;\r\n            // Reached the end of the message.\r\n            case 'end':\r\n                data = idata;\r\n\r\n                // In case end comes first.\r\n                this._received[id] = msg[2];\r\n\r\n                if (!data) {\r\n                    break;\r\n                }\r\n\r\n                this._ack(id);\r\n                break;\r\n            case 'ack':\r\n                data = odata;\r\n                if (!!data) {\r\n                    var ack = msg[2];\r\n                    // Take the larger ACK, for out of order messages.\r\n                    data.ack = Math.max(ack, data.ack);\r\n\r\n                    // Clean up when all chunks are ACKed.\r\n                    if (data.ack >= data.chunks.length) {\r\n                        util.log('Time: ', new Date() - data.timer);\r\n                        delete this._outgoing[id];\r\n                    } else {\r\n                        this._processAcks();\r\n                    }\r\n                }\r\n                // If !data, just ignore.\r\n                break;\r\n            // Received a chunk of data.\r\n            case 'chunk':\r\n                // Create a new entry if none exists.\r\n                data = idata;\r\n                if (!data) {\r\n                    var end = this._received[id];\r\n                    if (end === true) {\r\n                        break;\r\n                    }\r\n                    data = {\r\n                        ack: ['ack', id, 0],\r\n                        chunks: []\r\n                    };\r\n                    this._incoming[id] = data;\r\n                }\r\n\r\n                var n = msg[2];\r\n                var chunk = msg[3];\r\n                data.chunks[n] = new Uint8Array(chunk);\r\n\r\n                // If we get the chunk we're looking for, ACK for next missing.\r\n                // Otherwise, ACK the same N again.\r\n                if (n === data.ack[2]) {\r\n                    this._calculateNextAck(id);\r\n                }\r\n                this._ack(id);\r\n                break;\r\n            default:\r\n                // Shouldn't happen, but would make sense for message to just go\r\n                // through as is.\r\n                this._handleSend(msg);\r\n                break;\r\n        }\r\n    };\r\n\r\n// Chunks BL into smaller messages.\r\n    Reliable.prototype._chunk = function(bl) {\r\n        var chunks = [];\r\n        var size = bl.size;\r\n        var start = 0;\r\n        while (start < size) {\r\n            var end = Math.min(size, start + this._mtu);\r\n            var b = bl.slice(start, end);\r\n            var chunk = {\r\n                payload: b\r\n            }\r\n            chunks.push(chunk);\r\n            start = end;\r\n        }\r\n        util.log('Created', chunks.length, 'chunks.');\r\n        return chunks;\r\n    };\r\n\r\n// Sends ACK N, expecting Nth blob chunk for message ID.\r\n    Reliable.prototype._ack = function(id) {\r\n        var ack = this._incoming[id].ack;\r\n\r\n        // if ack is the end value, then call _complete.\r\n        if (this._received[id] === ack[2]) {\r\n            this._complete(id);\r\n            this._received[id] = true;\r\n        }\r\n\r\n        this._handleSend(ack);\r\n    };\r\n\r\n// Calculates the next ACK number, given chunks.\r\n    Reliable.prototype._calculateNextAck = function(id) {\r\n        var data = this._incoming[id];\r\n        var chunks = data.chunks;\r\n        for (var i = 0, ii = chunks.length; i < ii; i += 1) {\r\n            // This chunk is missing!!! Better ACK for it.\r\n            if (chunks[i] === undefined) {\r\n                data.ack[2] = i;\r\n                return;\r\n            }\r\n        }\r\n        data.ack[2] = chunks.length;\r\n    };\r\n\r\n// Sends the next window of chunks.\r\n    Reliable.prototype._sendWindowedChunks = function(id) {\r\n        util.log('sendWindowedChunks for: ', id);\r\n        var data = this._outgoing[id];\r\n        var ch = data.chunks;\r\n        var chunks = [];\r\n        var limit = Math.min(data.ack + this._window, ch.length);\r\n        for (var i = data.ack; i < limit; i += 1) {\r\n            if (!ch[i].sent || i === data.ack) {\r\n                ch[i].sent = true;\r\n                chunks.push(['chunk', id, i, ch[i].payload]);\r\n            }\r\n        }\r\n        if (data.ack + this._window >= ch.length) {\r\n            chunks.push(['end', id, ch.length])\r\n        }\r\n        chunks._multiple = true;\r\n        this._handleSend(chunks);\r\n    };\r\n\r\n// Puts together a message from chunks.\r\n    Reliable.prototype._complete = function(id) {\r\n        util.log('Completed called for', id);\r\n        var self = this;\r\n        var chunks = this._incoming[id].chunks;\r\n        var bl = new Blob(chunks);\r\n        util.blobToArrayBuffer(bl, function(ab) {\r\n            self.onmessage(util.unpack(ab));\r\n        });\r\n        delete this._incoming[id];\r\n    };\r\n\r\n// Ups bandwidth limit on SDP. Meant to be called during offer/answer.\r\n    Reliable.higherBandwidthSDP = function(sdp) {\r\n        // AS stands for Application-Specific Maximum.\r\n        // Bandwidth number is in kilobits / sec.\r\n        // See RFC for more info: http://www.ietf.org/rfc/rfc2327.txt\r\n\r\n        // Chrome 31+ doesn't want us munging the SDP, so we'll let them have their\r\n        // way.\r\n        var version = navigator.appVersion.match(/Chrome\\/(.*?) /);\r\n        if (version) {\r\n            version = parseInt(version[1].split('.').shift());\r\n            if (version < 31) {\r\n                var parts = sdp.split('b=AS:30');\r\n                var replace = 'b=AS:102400'; // 100 Mbps\r\n                if (parts.length > 1) {\r\n                    return parts[0] + replace + parts[1];\r\n                }\r\n            }\r\n        }\r\n\r\n        return sdp;\r\n    };\r\n\r\n// Overwritten, typically.\r\n    Reliable.prototype.onmessage = function(msg) {};\r\n\r\n    module.exports.Reliable = Reliable;\r\n\r\n},{\"./util\":13}],13:[function(require,module,exports){\r\n    var BinaryPack = require('js-binarypack');\r\n\r\n    var util = {\r\n        debug: false,\r\n\r\n        inherits: function(ctor, superCtor) {\r\n            ctor.super_ = superCtor;\r\n            ctor.prototype = Object.create(superCtor.prototype, {\r\n                constructor: {\r\n                    value: ctor,\r\n                    enumerable: false,\r\n                    writable: true,\r\n                    configurable: true\r\n                }\r\n            });\r\n        },\r\n        extend: function(dest, source) {\r\n            for(var key in source) {\r\n                if(source.hasOwnProperty(key)) {\r\n                    dest[key] = source[key];\r\n                }\r\n            }\r\n            return dest;\r\n        },\r\n        pack: BinaryPack.pack,\r\n        unpack: BinaryPack.unpack,\r\n\r\n        log: function () {\r\n            if (util.debug) {\r\n                var copy = [];\r\n                for (var i = 0; i < arguments.length; i++) {\r\n                    copy[i] = arguments[i];\r\n                }\r\n                copy.unshift('Reliable: ');\r\n                console.log.apply(console, copy);\r\n            }\r\n        },\r\n\r\n        setZeroTimeout: (function(global) {\r\n            var timeouts = [];\r\n            var messageName = 'zero-timeout-message';\r\n\r\n            // Like setTimeout, but only takes a function argument.\t There's\r\n            // no time argument (always zero) and no arguments (you have to\r\n            // use a closure).\r\n            function setZeroTimeoutPostMessage(fn) {\r\n                timeouts.push(fn);\r\n                global.postMessage(messageName, '*');\r\n            }\r\n\r\n            function handleMessage(event) {\r\n                if (event.source == global && event.data == messageName) {\r\n                    if (event.stopPropagation) {\r\n                        event.stopPropagation();\r\n                    }\r\n                    if (timeouts.length) {\r\n                        timeouts.shift()();\r\n                    }\r\n                }\r\n            }\r\n            if (global.addEventListener) {\r\n                global.addEventListener('message', handleMessage, true);\r\n            } else if (global.attachEvent) {\r\n                global.attachEvent('onmessage', handleMessage);\r\n            }\r\n            return setZeroTimeoutPostMessage;\r\n        }(this)),\r\n\r\n        blobToArrayBuffer: function(blob, cb){\r\n            var fr = new FileReader();\r\n            fr.onload = function(evt) {\r\n                cb(evt.target.result);\r\n            };\r\n            fr.readAsArrayBuffer(blob);\r\n        },\r\n        blobToBinaryString: function(blob, cb){\r\n            var fr = new FileReader();\r\n            fr.onload = function(evt) {\r\n                cb(evt.target.result);\r\n            };\r\n            fr.readAsBinaryString(blob);\r\n        },\r\n        binaryStringToArrayBuffer: function(binary) {\r\n            var byteArray = new Uint8Array(binary.length);\r\n            for (var i = 0; i < binary.length; i++) {\r\n                byteArray[i] = binary.charCodeAt(i) & 0xff;\r\n            }\r\n            return byteArray.buffer;\r\n        },\r\n        randomToken: function () {\r\n            return Math.random().toString(36).substr(2);\r\n        }\r\n    };\r\n\r\n    module.exports = util;\r\n\r\n},{\"js-binarypack\":10}]},{},[3]);\r\n"]}